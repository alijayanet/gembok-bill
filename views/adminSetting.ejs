<!-- Halaman Tab Setting Admin -->
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Admin Setting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/responsive-admin.css" rel="stylesheet">
    <style>
        body {
            background: #f5f6fa;
        }

        .main-content {
            padding: 32px 24px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .form-label {
            font-weight: 600;
        }

        .form-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            height: 100%;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .qr-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            border-radius: 12px;
        }

        #wa-qr-container {
            min-height: 250px;
            align-items: center;
        }

        #wa-qr-div {
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .command-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .command-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .command-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-list {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .command-list code {
            background: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .logo-preview {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
        }

        .logo-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .logo-preview img[src$=".svg"] {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 120px;
        }

        .status-badge {
            font-size: 0.9rem;
            padding: 8px 12px;
        }

        .alert-custom {
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-warning {
            border-left-color: #ffc107;
        }

        .alert-info {
            border-left-color: #17a2b8;
        }

        .alert-success {
            border-left-color: #28a745;
        }

        .alert-danger {
            border-left-color: #dc3545;
        }

        /* Mobile responsive fixes */
        @media (max-width: 767.98px) {
            .main-content {
                margin-top: 70px !important;
                /* Extra space for mobile navbar */
                padding-top: 10px !important;
                z-index: 1;
            }

            .card {
                z-index: 1;
            }

            /* Pastikan cards tidak overlap dengan mobile navbar */
            .row.mb-4:first-of-type {
                margin-top: 10px;
            }

            /* Responsive notification positioning */
            #restartNotif {
                top: 80px !important;
                /* Below mobile navbar */
                right: 10px !important;
                left: 10px !important;
                width: auto !important;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Include Responsive Admin Sidebar -->
            <%- include('partials/admin-responsive-sidebar', { page: 'setting' , settings: settings }) %>

                <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <h3 class="mb-4">Pengaturan Sistem</h3>

                    <div class="row">
                        <!-- Kolom 1: Pengaturan Sistem -->
                        <div class="col-base col-lg-4 mb-4">

                            <!-- Section Pengaturan -->
                            <div class="form-section">
                                <h5 class="mb-3">
                                    <i class="bi bi-gear text-primary"></i> Pengaturan Sistem
                                </h5>
                                <form id="settingsForm">
                                    <div id="settingsFields"></div>
                                    <div id="settingsSuccess" class="alert alert-success d-none" role="alert"></div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                        <button type="button" class="btn btn-outline-info me-2" id="testConnectionBtn">
                                            <i class="bi bi-wifi"></i> Test Koneksi
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-save"></i> Simpan Perubahan
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Kolom 2: WhatsApp & Telegram -->
                        <div class="col-lg-4 mb-4">
                            <div class="form-section">
                                <h5 class="mb-3">
                                    <i class="bi bi-whatsapp text-success"></i> WhatsApp Gateway
                                </h5>

                                <div class="text-center mb-3">
                                    <div id="wa-status" class="mb-2"></div>
                                    <div id="wa-qr-container" class="d-flex justify-content-center mb-2 d-none">
                                        <div class="position-relative">
                                            <img id="wa-qr" src="#" alt="QR Code WhatsApp"
                                                class="img-fluid rounded shadow"
                                                style="max-width: 100%; height: auto; display: none;">
                                            <div id="wa-qr-div" class="d-flex justify-content-center"></div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button class="btn btn-success btn-sm" id="btnRefreshQR">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh QR
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" id="btnDeleteSession">
                                            <i class="bi bi-trash"></i> Hapus Session
                                        </button>
                                    </div>
                                </div>

                                <div class="alert alert-warning alert-custom mb-3">
                                    <div class="d-flex align-items-start small">
                                        <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                                        <div>
                                            <strong>⚠️ PENTING!</strong> Gunakan nomor WhatsApp <strong>BUKAN nomor
                                                admin</strong> untuk scan QR.
                                        </div>
                                    </div>
                                </div>

                                <!-- Compact Logo & Donation (Moved here) -->
                                <div class="border-top pt-3 mt-3">
                                    <div class="row align-items-center">
                                        <div class="col-7">
                                            <h6 class="mb-2 small fw-bold text-success"><i class="bi bi-image"></i> Logo
                                                & Donasi</h6>
                                            <form id="logoUploadForm" enctype="multipart/form-data"
                                                class="d-flex gap-1 mb-2">
                                                <input type="file" name="logo" accept="image/*,.svg"
                                                    class="form-control form-control-sm" style="font-size: 0.7rem;"
                                                    required>
                                                <button type="submit" class="btn btn-success btn-sm px-2 py-0"
                                                    style="font-size: 0.7rem;">Upload</button>
                                            </form>
                                            <div class="text-center bg-light p-1 rounded border">
                                                <img src="/admin/settings/donation-qr?ts=<%= Date.now() %>" alt="QR"
                                                    style="max-width:80px; height:auto;">
                                                <div style="font-size:0.6rem;" class="mt-1 text-muted">Donasi Sistem
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-5 text-center">
                                            <div class="logo-preview p-1 border rounded bg-white">
                                                <img id="logoPreview"
                                                    src="/img/<%= typeof settings !== 'undefined' && settings.logo_filename ? settings.logo_filename : 'logo.png' %>?ts=<%= Date.now() %>"
                                                    alt="Logo" style="max-width:100%; max-height:70px;">
                                                <div class="mt-1 small text-muted" style="font-size: 0.6rem;">Preview
                                                    Logo</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="border-top pt-4 mt-4">
                                    <h5 class="mb-3">
                                        <i class="bi bi-telegram text-primary"></i> Telegram Bot Gateway
                                    </h5>
                                    <div id="tg-status" class="text-center mb-2"></div>
                                    <div class="d-flex gap-2 justify-content-center mb-3">
                                        <button class="btn btn-outline-info btn-sm" id="btnRestartBot">
                                            <i class="bi bi-arrow-clockwise"></i> Restart Bot
                                        </button>
                                    </div>
                                    <div id="tg-stats" class="bg-light p-2 rounded small" style="display:none">
                                        <div class="row g-2 text-center">
                                            <div class="col-6">Users: <span id="tg-total-users" class="fw-bold">0</span>
                                            </div>
                                            <div class="col-6">Active: <span id="tg-active-sessions"
                                                    class="fw-bold text-success">0</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kolom 3: Tool & Generator -->
                        <div class="col-base col-lg-4 mb-4">
                            <div class="form-section">
                                <h5 class="mb-3">
                                    <i class="bi bi-tools text-warning"></i> Tool & Generator
                                </h5>
                                <!-- Tool & Generator Section -->
                                <div class="mt-2">
                                    <h5 class="mb-3"><i class="bi bi-router"></i> Script Generator Menu Isolir
                                        Mikrotik
                                    </h5>
                                    <p class="small text-muted mb-3">Generate script untuk mengatur menu isolir di
                                        Mikrotik. Pelanggan yang diisolir akan langsung diarahkan ke halaman isolir.
                                    </p>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">IP PPPoE Aktif</label>
                                            <input type="text" class="form-control form-control-sm" id="activeIp"
                                                placeholder="192.168.10.1" value="192.168.10.1">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">IP PPPoE Isolir</label>
                                            <input type="text" class="form-control form-control-sm" id="isolirIp"
                                                placeholder="192.168.200.1" value="192.168.200.1">
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">Domain/IP Aplikasi</label>
                                            <input type="text" class="form-control form-control-sm" id="isolirDomain"
                                                placeholder="192.168.8.89" value="192.168.8.89">
                                            <small class="text-muted">IP atau domain aplikasi (contoh: 192.168.8.89
                                                atau
                                                alijaya.gantiwifi.online)</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">Path Halaman Isolir</label>
                                            <input type="text" class="form-control form-control-sm" id="isolirPath"
                                                placeholder="/isolir" value="/isolir">
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">Port Aplikasi</label>
                                            <input type="text" class="form-control form-control-sm" id="isolirPort"
                                                placeholder="3003" value="3003">
                                            <small class="text-muted">Port aplikasi (contoh: 3003 untuk aplikasi
                                                lokal)</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold">Jenis Akses</label>
                                            <select class="form-select form-select-sm" id="accessType">
                                                <option value="port">Port Langsung (Recommended)</option>
                                                <option value="tunneling">Tunneling (Domain + Path)</option>
                                            </select>
                                            <small class="text-muted">Port Langsung untuk aplikasi lokal, Tunneling
                                                untuk domain</small>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <button type="button" class="btn btn-primary btn-sm"
                                            onclick="generateIsolirScript()">
                                            <i class="bi bi-gear"></i> Generate Script
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm ms-2"
                                            onclick="generateLocalIsolirScript()">
                                            <i class="bi bi-house"></i> Generate Script Lokal
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2"
                                            onclick="copyIsolirScript()">
                                            <i class="bi bi-clipboard"></i> Copy Script
                                        </button>
                                    </div>

                                    <div class="command-card" id="isolirScriptCard" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0"><i class="bi bi-terminal"></i> Script Mikrotik</h6>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                onclick="copyIsolirScript()">
                                                <i class="bi bi-clipboard"></i> Copy
                                            </button>
                                        </div>
                                        <pre id="isolirScript" class="mb-0"
                                            style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; font-size: 12px; max-height: 400px; overflow-y: auto;"></pre>
                                    </div>

                                    <div class="alert alert-info mt-3" id="isolirInfo">
                                        <h6><i class="bi bi-info-circle"></i> Cara Penggunaan:</h6>
                                        <ol class="mb-0">
                                            <li>Masukkan IP PPPoE aktif dan isolir</li>
                                            <li>Masukkan IP/domain aplikasi dan path halaman isolir</li>
                                            <li>Masukkan port aplikasi (contoh: 3003 untuk aplikasi lokal)</li>
                                            <li>Pilih jenis akses: <strong>Port Langsung</strong> (recommended) atau
                                                <strong>Tunneling</strong>
                                            </li>
                                            <li>Klik "Generate Script"</li>
                                            <li>Copy script dan jalankan di terminal Mikrotik</li>
                                            <li>Script akan membuat redirect yang mengarahkan ke halaman isolir</li>
                                        </ol>
                                        <div class="mt-2">
                                            <strong>Contoh Aplikasi Lokal:</strong> 192.168.8.89:3003/isolir<br>
                                            <strong>Contoh Domain:</strong> alijaya.gantiwifi.online/isolir<br>
                                            <strong>Keuntungan:</strong> Tidak perlu web proxy, performa lebih baik
                                        </div>
                                    </div>
                                </div>

                                <!-- Kalkulator Burst Limit -->
                                <div class="mt-4">
                                    <h5 class="mb-3"><i class="bi bi-calculator"></i> Kalkulator Burst Limit</h5>
                                    <p class="small text-muted mb-3">Untuk profil Hotspot atau PPPoE.</p>

                                    <!-- Rate Limit -->
                                    <label class="form-label small fw-bold">Rate Limit (dan Threshold)</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-7">
                                            <input type="number" class="form-control form-control-sm" id="uploadRate"
                                                placeholder="cth: 100">
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="uploadUnit">
                                                <option value="k" selected>Kbps</option>
                                                <option value="M">Mbps</option>
                                            </select>
                                        </div>
                                        <div class="col-7">
                                            <input type="number" class="form-control form-control-sm" id="downloadRate"
                                                placeholder="cth: 100">
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="downloadUnit">
                                                <option value="k">Kbps</option>
                                                <option value="M" selected>Mbps</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Burst Limit -->
                                    <label class="form-label small fw-bold">Burst Limit</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-7">
                                            <input type="number" class="form-control form-control-sm"
                                                id="uploadBurstRate" placeholder="cth: 100">
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="uploadBurstUnit">
                                                <option value="k" selected>Kbps</option>
                                                <option value="M">Mbps</option>
                                            </select>
                                        </div>
                                        <div class="col-7">
                                            <input type="number" class="form-control form-control-sm"
                                                id="downloadBurstRate" placeholder="cth: 100">
                                        </div>
                                        <div class="col-5">
                                            <select class="form-select form-select-sm" id="downloadBurstUnit">
                                                <option value="k">Kbps</option>
                                                <option value="M" selected>Mbps</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Burst Time -->
                                    <div class="mb-3">
                                        <label for="burstTime" class="form-label small fw-bold">Burst Time
                                            (detik)</label>
                                        <input type="number" class="form-control form-control-sm" id="burstTime"
                                            value="8" placeholder="cth: 8">
                                    </div>

                                    <!-- Hasil -->
                                    <div>
                                        <label for="burstResult" class="form-label small fw-bold">Hasil</label>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control form-control-sm bg-light"
                                                id="burstResult" readonly placeholder="Hasil akan muncul di sini">
                                            <button class="btn btn-outline-secondary btn-sm" type="button"
                                                id="copyBurstBtn">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                        <button class="btn btn-primary btn-sm w-100" type="button"
                                            id="generateBurstLimit">
                                            <i class="bi bi-lightning-charge"></i> Generate
                                        </button>
                                    </div>
                                </div>

                                <!-- DNS Management Section -->
                                <div class="mt-4">
                                    <h5 class="mb-3"><i class="bi bi-globe"></i> DNS Management GenieACS</h5>
                                    <p class="small text-muted mb-3">Konfigurasi DNS Server untuk ONUs melalui
                                        GenieACS.
                                        Menggunakan console script untuk keandalan maksimal.</p>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label small fw-bold" for="dnsServerIp">DNS Server
                                                    IP</label>
                                                <input type="text" class="form-control form-control-sm" id="dnsServerIp"
                                                    value="192.168.8.89" placeholder="192.168.8.89">
                                                <small class="form-text text-muted">IP server GenieACS yang akan
                                                    dijadikan DNS</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label small fw-bold" for="deviceIdInput">Device
                                                    ID
                                                    (Opsional)</label>
                                                <input type="text" class="form-control form-control-sm"
                                                    id="deviceIdInput" placeholder="C0FD84-F663NV3A-ZTEGCB8BB94C">
                                                <small class="form-text text-muted">Kosongkan untuk konfigurasi
                                                    semua
                                                    device online</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex mb-3">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="testGenieACSConnection()">
                                            <i class="bi bi-plug"></i> Test Koneksi
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm"
                                            onclick="loadOnlineDevices()">
                                            <i class="bi bi-arrow-clockwise"></i> Refresh Device
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm" onclick="configureDNS()">
                                            <i class="bi bi-gear"></i> Konfigurasi DNS
                                        </button>
                                        <button type="button" class="btn btn-warning btn-sm"
                                            onclick="configureAllOnline()">
                                            <i class="bi bi-broadcast-tower"></i> Konfigurasi Semua Online
                                        </button>
                                    </div>

                                    <div id="connectionStatus" class="mb-3"></div>

                                    <!-- Device List -->
                                    <div id="deviceList" class="mt-4" style="display: none;">
                                        <h6>Device Online (Last 24 hours):</h6>
                                        <div id="deviceListContent" class="row"></div>
                                    </div>

                                    <!-- Activity Log -->
                                    <div class="mt-4">
                                        <h6>Activity Log:</h6>
                                        <div id="logContainer" class="log-container"
                                            style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.375rem; height: 200px; overflow-y: auto; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Mikrotik DNS GenieACS Script Generator -->
                                <div class="mt-4">
                                    <h5 class="mb-3"><i class="bi bi-router"></i> Generator Script Mikrotik DNS
                                        GenieACS
                                    </h5>
                                    <p class="small text-muted mb-3">Generate script Mikrotik untuk konfigurasi DNS
                                        dan
                                        TR069 GenieACS. Script siap copy-paste ke terminal Mikrotik.</p>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label small fw-bold" for="genieacsServerIp">IP
                                                    Server
                                                    GenieACS</label>
                                                <input type="text" class="form-control form-control-sm"
                                                    id="genieacsServerIp" value="192.168.8.89"
                                                    placeholder="192.168.8.89">
                                                <small class="form-text text-muted">IP server GenieACS yang akan
                                                    dijadikan DNS</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label small fw-bold" for="genieacsPort">Port
                                                    GenieACS</label>
                                                <input type="number" class="form-control form-control-sm"
                                                    id="genieacsPort" value="7547" placeholder="7547">
                                                <small class="form-text text-muted">Port TR069 GenieACS (default:
                                                    7547)</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label small fw-bold" for="pppoeRange">Range
                                                    PPPoE</label>
                                                <input type="text" class="form-control form-control-sm" id="pppoeRange"
                                                    value="192.168.10.0/24" placeholder="192.168.10.0/24">
                                                <small class="form-text text-muted">Range IP PPPoE yang akan
                                                    dikonfigurasi</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label small fw-bold" for="dnsBackup">DNS
                                                    Backup</label>
                                                <input type="text" class="form-control form-control-sm" id="dnsBackup"
                                                    value="8.8.8.8" placeholder="8.8.8.8">
                                                <small class="form-text text-muted">DNS server backup
                                                    (opsional)</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex mb-3">
                                        <button type="button" class="btn btn-primary btn-sm"
                                            onclick="generateMikrotikDNSGenieACSScript()">
                                            <i class="bi bi-file-earmark-code"></i> Generate Script
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm"
                                            onclick="copyMikrotikDNSGenieACSScript()" id="copyMikrotikDNSGenieACSBtn"
                                            disabled>
                                            <i class="bi bi-clipboard"></i> Copy Script
                                        </button>
                                        <button type="button" class="btn btn-info btn-sm"
                                            onclick="downloadMikrotikDNSGenieACSScript()"
                                            id="downloadMikrotikDNSGenieACSBtn" disabled>
                                            <i class="bi bi-download"></i> Download Script
                                        </button>
                                    </div>

                                    <!-- Script Output -->
                                    <div id="mikrotikDNSGenieACSScriptOutput" class="mt-3" style="display: none;">
                                        <h6>Generated Mikrotik Script:</h6>
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <span><i class="bi bi-code-slash"></i> Mikrotik DNS GenieACS
                                                    Script</span>
                                                <small class="text-muted">Siap untuk copy-paste ke terminal
                                                    Mikrotik</small>
                                            </div>
                                            <div class="card-body">
                                                <pre id="mikrotikDNSGenieACSScriptContent" class="mb-0"
                                                    style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 0.375rem; padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.875rem; max-height: 400px; overflow-y: auto;"></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">
                                <!-- VPS & MikroTik WireGuard + GenieACS Generator -->
                                <div class="mt-4">
                                    <h5 class="mb-3"><i class="bi bi-server"></i> Generator Konfigurasi VPS &
                                        MikroTik
                                    </h5>
                                    <p class="small text-muted mb-3">Generate skrip untuk menghubungkan VPS dan
                                        MikroTik
                                        dengan WireGuard dan GenieACS.</p>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-header bg-primary text-white">
                                                    <i class="bi bi-hdd-rack"></i> Konfigurasi VPS
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">IP Publik
                                                            VPS</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="vpsPublicIp" placeholder="contoh: 123.123.123.123">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">Interface Jaringan
                                                            (biasanya eth0 atau ens3)</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="vpsInterface" value="eth0">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">Port
                                                            WireGuard</label>
                                                        <input type="number" class="form-control form-control-sm"
                                                            id="wgPort" value="51820">
                                                    </div>
                                                    <button class="btn btn-primary btn-sm w-100" id="generateVpsScript">
                                                        <i class="bi bi-file-earmark-code"></i> Generate Skrip VPS
                                                    </button>
                                                    <button class="btn btn-success btn-sm w-100 mt-2"
                                                        id="downloadVpsScript" disabled>
                                                        <i class="bi bi-download"></i> Unduh Skrip VPS
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="card h-100">
                                                <div class="card-header bg-success text-white">
                                                    <i class="bi bi-router"></i> Konfigurasi MikroTik
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">IP Lokal MikroTik
                                                            (WireGuard)</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="mikrotikLocalIp" value="10.10.10.2">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">IP VPS
                                                            (WireGuard)</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="vpsLocalIp" value="10.10.10.1">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label small fw-bold">Subnet
                                                            Jaringan</label>
                                                        <input type="text" class="form-control form-control-sm"
                                                            id="networkSubnet" value="10.10.10.0/24">
                                                    </div>
                                                    <button class="btn btn-success btn-sm w-100"
                                                        id="generateMikrotikScript">
                                                        <i class="bi bi-file-earmark-code"></i> Generate Skrip
                                                        MikroTik
                                                    </button>
                                                    <button class="btn btn-success btn-sm w-100 mt-2"
                                                        id="downloadMikrotikScript" disabled>
                                                        <i class="bi bi-download"></i> Unduh Skrip MikroTik
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div
                                                    class="card-header d-flex justify-content-between align-items-center">
                                                    <span><i class="bi bi-terminal"></i> Skrip Hasil Generate</span>
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                        id="copyAllScripts">
                                                        <i class="bi bi-clipboard"></i> Salin Semua
                                                    </button>
                                                </div>
                                                <div class="card-body p-0">
                                                    <pre class="mb-0 p-3 bg-light" id="generatedScript"
                                                        style="min-height: 200px; max-height: 400px; overflow-y: auto;">
Pilih opsi di atas untuk men-generate skrip...
                    </pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- DHCP Option 43 Generator for GenieACS -->
                                <div class="mt-4">
                                    <h5 class="mb-3"><i class="bi bi-ethernet"></i> Generator DHCP Option 43</h5>
                                    <p class="small text-muted mb-3">Generate nilai hex untuk DHCP Option 43 (Vendor
                                        Specific Information) yang berisi URL GenieACS.</p>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-8">
                                            <label class="form-label small fw-bold" for="genieacsUrl">URL
                                                GenieACS</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-sm" id="genieacsUrl"
                                                    placeholder="cth: https://genieacs.example.com:7547">
                                                <button class="btn btn-outline-primary btn-sm" type="button"
                                                    id="generateOption43">Generate</button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold">Hasil Option 43</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-sm bg-light"
                                                    id="option43Result" readonly>
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="copyOption43Btn" title="Salin ke clipboard">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert alert-info small p-2 mb-0">
                                        <i class="bi bi-info-circle"></i> Gunakan nilai ini di MikroTik:
                                        <code>/ip dhcp-server option add name=opt43 code=43 value=0x<span id="option43Value"></span></code>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Mikrotik Isolation Script Generator -->
                                <div class="mt-4">
                                    <h5 class="mb-3"><i class="bi bi-shield-lock"></i> Generator Script Isolir
                                        Mikrotik
                                    </h5>
                                    <p class="small text-muted mb-3">Generate script Mikrotik untuk sistem isolir
                                        pelanggan IP statik. Script siap copy-paste ke terminal Mikrotik.</p>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold" for="isolationMethod">Metode
                                                Isolir</label>
                                            <select class="form-select form-select-sm" id="isolationMethod">
                                                <option value="address_list">Address List (Recommended)</option>
                                                <option value="dhcp_block">DHCP Block</option>
                                                <option value="bandwidth_limit">Bandwidth Limit</option>
                                                <option value="firewall_rule">Firewall Rule</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold" for="bandwidthLimit">Bandwidth
                                                Limit
                                                (jika dipilih)</label>
                                            <input type="text" class="form-control form-control-sm" id="bandwidthLimit"
                                                placeholder="1k/1k" value="1k/1k">
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold" for="networkRange">Network Range
                                                (untuk monitoring)</label>
                                            <input type="text" class="form-control form-control-sm" id="networkRange"
                                                placeholder="192.168.1.0/24" value="192.168.1.0/24">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold" for="dnsServers">DNS
                                                Servers</label>
                                            <input type="text" class="form-control form-control-sm" id="dnsServers"
                                                placeholder="8.8.8.8,8.8.4.4" value="8.8.8.8,8.8.4.4">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <button class="btn btn-primary btn-sm" type="button"
                                            id="generateIsolationScript">
                                            <i class="bi bi-gear"></i> Generate Script
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm ms-2" type="button"
                                            id="previewIsolationScript">
                                            <i class="bi bi-eye"></i> Preview
                                        </button>
                                    </div>

                                    <div class="row g-2 mb-3">
                                        <div class="col-12">
                                            <label class="form-label small fw-bold">Script Mikrotik</label>
                                            <div class="input-group">
                                                <textarea class="form-control form-control-sm"
                                                    id="isolationScriptResult" rows="15" readonly
                                                    style="font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                                                <button class="btn btn-outline-secondary btn-sm" type="button"
                                                    id="copyIsolationScriptBtn" title="Salin ke clipboard">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-info small p-2 mb-0">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Cara menggunakan:</strong>
                                        1. Klik "Generate Script" → 2. Copy script → 3. Paste di terminal Mikrotik →
                                        4.
                                        Jalankan script
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- Optical Splitter Attenuation Calculator -->
                                <div class="mt-4">
                                    <h5 class="mb-3"><i class="bi bi-lightning-charge"></i> Kalkulator Redaman
                                        Splitter
                                        Optik</h5>
                                    <p class="small text-muted mb-3">Hitung redaman splitter optik dan RX power
                                        setelah
                                        splitter. Cocok untuk OLT, FDT, FDX, dan ONT.</p>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold" for="rxAwal">RX Awal
                                                (dBm)</label>
                                            <input type="number" class="form-control form-control-sm" id="rxAwal"
                                                placeholder="cth: -18">
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold" for="splitterRatio">Rasio
                                                Splitter</label>
                                            <select class="form-select form-select-sm" id="splitterRatio">
                                                <option value="2">1:2</option>
                                                <option value="4">1:4</option>
                                                <option value="8">1:8</option>
                                                <option value="16">1:16</option>
                                                <option value="32">1:32</option>
                                                <option value="64">1:64</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold" for="fiberLength">Panjang
                                                Kabel</label>
                                            <input type="number" class="form-control form-control-sm" id="fiberLength"
                                                placeholder="cth: 2" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold" for="connectorCount">Jumlah
                                                Konektor</label>
                                            <input type="number" class="form-control form-control-sm"
                                                id="connectorCount" placeholder="cth: 4" min="0">
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold" for="spliceCount">Jumlah Splice
                                                kabel</label>
                                            <input type="number" class="form-control form-control-sm" id="spliceCount"
                                                placeholder="cth: 2" min="0">
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold" for="margin">Margin Cadangan
                                                (dB)</label>
                                            <input type="number" class="form-control form-control-sm" id="margin"
                                                placeholder="cth: 2" min="0" value="2">
                                        </div>
                                    </div>
                                    <div class="row g-2 mb-3">
                                        <div class="col-12 d-flex align-items-end">
                                            <button class="btn btn-primary btn-sm w-100" type="button"
                                                id="generateSplitterResult">
                                                <i class="bi bi-lightning-charge"></i> Generate
                                            </button>
                                        </div>
                                    </div>
                                    <div id="splitterResultSection" style="display:none">
                                        <div class="row g-2 mb-3">
                                            <div class="col-md-6 col-12">
                                                <label class="form-label small fw-bold">Redaman Splitter
                                                    (dB)</label>
                                                <input type="text" class="form-control form-control-sm bg-light"
                                                    id="splitterAttenuation" readonly
                                                    placeholder="Redaman akan muncul di sini">
                                            </div>
                                            <div class="col-md-6 col-12">
                                                <label class="form-label small fw-bold">RX Setelah Splitter
                                                    (dBm)</label>
                                                <input type="text" class="form-control form-control-sm bg-light"
                                                    id="rxSetelahSplitter" readonly
                                                    placeholder="RX setelah splitter akan muncul di sini">
                                            </div>
                                        </div>
                                        <div class="table-responsive mb-2">
                                            <table class="table table-sm table-bordered align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Rasio</th>
                                                        <th>Redaman (dB)</th>
                                                        <th>RX Setelah Splitter (dBm)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="splitterTableBody">
                                                    <!-- Table rows generated by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Penutup Row Internal -->
                </main>
        </div>
    </div>
    <!-- Modal Konfirmasi Restart Mikrotik -->
    <div class="modal fade" id="restartMikrotikModal" tabindex="-1" aria-labelledby="restartMikrotikModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="restartMikrotikModalLabel"><i class="bi bi-arrow-repeat"></i> Konfirmasi
                        Restart Mikrotik</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Apakah Anda yakin ingin <b>restart Mikrotik</b>?<br>Router akan reboot dan koneksi internet
                    pelanggan akan terputus sementara.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmRestartMikrotik">Restart</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Notifikasi -->
    <div id="restartNotif" class="alert d-none position-fixed top-0 end-0 m-4" style="z-index:1055; min-width:300px;">
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Load QRCode.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        $(function () {
            // Fungsi untuk mendapatkan label yang user-friendly
            function getFieldLabel(key) {
                const fieldLabels = {
                    'auto_suspension_enabled': 'Auto Suspension (Isolir Otomatis)',
                    'suspension_grace_period_days': 'Grace Period Suspension (Hari)',
                    'default_pppoe_profile': 'Profile PPPoE Default',
                    'admins.0': 'Nomor Admin Utama',
                    'admins.1': 'Nomor Admin Tambahan 1',
                    'admins.2': 'Nomor Admin Tambahan 2',
                    'technician_numbers.0': 'Nomor Teknisi 1',
                    'technician_numbers.1': 'Nomor Teknisi 2',
                    'technician_numbers.2': 'Nomor Teknisi 3',
                    'admin_username': 'Username Admin',
                    'admin_password': 'Password Admin',
                    'genieacs_url': 'URL GenieACS',
                    'genieacs_username': 'Username GenieACS',
                    'genieacs_password': 'Password GenieACS',
                    'mikrotik_host': 'Host/IP Mikrotik',
                    'mikrotik_port': 'Port API Mikrotik',
                    'mikrotik_user': 'Username Mikrotik',
                    'mikrotik_password': 'Password Mikrotik',
                    'main_interface': 'Interface Utama',
                    'pppoe_monitor_enable': 'Monitor PPPoE',
                    'pppoe_monitor_interval_minutes': 'Interval Monitor PPPoE (Menit)',
                    'whatsapp_keep_alive': 'WhatsApp Keep Alive',
                    'whatsapp_restart_on_error': 'Restart WhatsApp on Error',
                    'rx_power_warning': 'RX Power Warning (dBm)',
                    'rx_power_critical': 'RX Power Critical (dBm)',
                    'rx_power_notification_enable': 'Notifikasi RX Power',
                    'rx_power_warning_interval_hours': 'Interval Peringatan RX Power (Jam)',
                    'company_header': 'Header Perusahaan',
                    'app_name': 'Nama Aplikasi',
                    'footer_info': 'Info Footer',
                    'customerPortalOtp': 'OTP Customer Portal',
                    'otp_length': 'Panjang OTP',
                    'otp_expiry_minutes': 'Masa Berlaku OTP (Menit)',
                    'server_host': 'Host Server',
                    'trouble_report.enabled': 'Laporan Gangguan',
                    'trouble_report.categories': 'Kategori Laporan',
                    'trouble_report.auto_ticket': 'Auto Ticket',
                    'rxpower_recap_enable': 'Ringkasan RX Power',
                    'rxpower_recap_interval_hours': 'Interval Ringkasan RX Power (Jam)',
                    'offline_notification_enable': 'Notifikasi Perangkat Offline',
                    'offline_notification_interval_hours': 'Interval Notifikasi Offline (Jam)',
                    'offline_device_threshold_hours': 'Batas Waktu Offline (Jam)',
                    'tax_settings.default_tax_rate': 'PPN Default (%)',
                    'tax_settings.tax_name': 'Nama Pajak',
                    'tax_settings.tax_enabled': 'Sistem PPN',
                    'tax_settings.tax_inclusive': 'Harga Sudah Termasuk PPN',
                    'telegram_bot.enabled': 'Telegram Bot',
                    'telegram_bot.bot_token': 'Bot Token Telegram',
                    'telegram_bot.session_timeout_hours': 'Timeout Sesi (Jam)',
                    'telegram_bot.auto_session_cleanup': 'Auto Cleanup Sesi',
                    'telegram_bot.allowed_users': 'Role yang Diizinkan',
                    'telegram_bot.notification_settings.enable_notifications': 'Aktifkan Notifikasi',
                    'telegram_bot.notification_settings.error_notifications': 'Notifikasi Error',
                    'telegram_bot.notification_settings.command_logging': 'Log Perintah',
                    'telegram_bot.mikrotik_settings.auto_comment_enabled': 'Auto Comment MikroTik',
                    'telegram_bot.mikrotik_settings.comment_format': 'Format Comment',
                    'telegram_bot.mikrotik_settings.session_management_enabled': 'Manajemen Sesi Otomatis'
                };
                return fieldLabels[key] || key;
            }

            // Field yang tidak perlu ditampilkan di form settings
            // Hanya menyembunyikan field teknis yang tidak perlu diubah di server baru
            const hiddenFields = [
                // Version Info - Tidak perlu diubah manual
                'app_version', 'version_name', 'version_date', 'version_notes', 'build_number',

                // Interval Settings (millisecond format) - hanya tampilkan format jam
                'rx_power_warning_interval', 'rxpower_recap_interval', 'offline_notification_interval',

                // Duplicate/Alternative Fields
                'pppoe_notifications.enabled', 'pppoe_notifications.loginNotifications',
                'pppoe_notifications.logoutNotifications', 'pppoe_notifications.includeOfflineList',
                'pppoe_notifications.maxOfflineListCount'
            ];

            // Keterangan bahasa Indonesia untuk setiap pengaturan
            function getFieldDescription(key) {
                const descriptions = {
                    'auto_suspension_enabled': 'Aktifkan isolir otomatis untuk pelanggan yang tidak membayar',
                    'suspension_grace_period_days': 'Jumlah hari sebelum layanan disuspend setelah jatuh tempo',
                    'default_pppoe_profile': 'Profile PPPoE yang akan digunakan untuk pelanggan baru',
                    'isolir_profile': 'Profile PPPoE untuk pelanggan yang diisolir',
                    'static_ip_suspension_method': 'Metode untuk suspend IP statis (address_list atau disable)',
                    'suspension_bandwidth_limit': 'Batas bandwidth untuk pelanggan yang diisolir (contoh: 1k/1k)',
                    'admins.0': 'Nomor WhatsApp admin utama untuk menerima notifikasi',
                    'admins.1': 'Nomor WhatsApp admin tambahan (opsional)',
                    'admin_username': 'Username untuk login ke admin panel',
                    'admin_password': 'Password untuk login ke admin panel',
                    'genieacs_url': 'URL server GenieACS untuk monitoring perangkat',
                    'genieacs_username': 'Username untuk koneksi ke GenieACS',
                    'genieacs_password': 'Password untuk koneksi ke GenieACS',
                    'mikrotik_host': 'Alamat IP atau hostname router MikroTik',
                    'mikrotik_port': 'Port API MikroTik (default: 8728)',
                    'mikrotik_user': 'Username untuk koneksi ke MikroTik API',
                    'mikrotik_password': 'Password untuk koneksi ke MikroTik API',
                    'main_interface': 'Interface utama MikroTik untuk monitoring PPPoE',
                    'pppoe_monitor_enable': 'Aktifkan monitoring koneksi PPPoE secara real-time',
                    'technician_numbers.0': 'Nomor WhatsApp teknisi pertama',
                    'technician_numbers.1': 'Nomor WhatsApp teknisi kedua',
                    'technician_group_id': 'ID grup WhatsApp untuk teknisi',
                    'whatsapp_keep_alive': 'Pertahankan koneksi WhatsApp tetap aktif',
                    'whatsapp_restart_on_error': 'Restart otomatis WhatsApp jika terjadi error',
                    'rx_power_warning': 'Threshold RX Power untuk peringatan (dBm)',
                    'rx_power_critical': 'Threshold RX Power untuk kondisi kritis (dBm)',
                    'rx_power_notification_enable': 'Aktifkan notifikasi monitoring RX Power',
                    'rx_power_warning_interval_hours': 'Interval pengecekan RX Power (dalam jam)',
                    'company_header': 'Header yang ditampilkan di aplikasi',
                    'app_name': 'Nama aplikasi yang ditampilkan',
                    'footer_info': 'Informasi footer aplikasi',
                    'customerPortalOtp': 'Aktifkan OTP untuk customer portal',
                    'otp_length': 'Panjang kode OTP (4-6 digit)',
                    'otp_expiry_minutes': 'Masa berlaku OTP dalam menit',
                    'server_host': 'Alamat IP atau hostname server',
                    'trouble_report.enabled': 'Aktifkan fitur laporan gangguan',
                    'trouble_report.categories': 'Kategori laporan gangguan (pisahkan dengan koma)',
                    'trouble_report.auto_ticket': 'Buat tiket otomatis untuk laporan gangguan',
                    'rxpower_recap_enable': 'Aktifkan ringkasan RX Power harian',
                    'rxpower_recap_interval_hours': 'Interval pengiriman ringkasan RX Power (dalam jam)',
                    'offline_notification_enable': 'Aktifkan notifikasi perangkat offline',
                    'offline_notification_interval_hours': 'Interval pengecekan perangkat offline (dalam jam)',
                    'offline_device_threshold_hours': 'Batas waktu perangkat dianggap offline (dalam jam)',
                    'tax_settings.default_tax_rate': 'Tarif PPN default dalam persen',
                    'tax_settings.tax_name': 'Nama pajak yang ditampilkan (contoh: PPN)',
                    'tax_settings.tax_enabled': 'Aktifkan sistem PPN',
                    'tax_settings.tax_inclusive': 'Harga sudah termasuk PPN',
                    'user_auth_mode': 'Mode autentikasi user (mikrotik atau local)',
                    'server_port': 'Port server aplikasi',
                    'logo_filename': 'Nama file logo perusahaan',
                    'company_website': 'Website perusahaan',
                    'company_slogan': 'Slogan perusahaan',
                    'invoice_notes': 'Catatan yang ditampilkan di invoice',
                    'payment_bank_name': 'Nama bank untuk pembayaran',
                    'payment_account_number': 'Nomor rekening bank',
                    'payment_account_holder': 'Nama pemilik rekening',
                    'payment_cash_address': 'Alamat untuk pembayaran tunai',
                    'payment_cash_hours': 'Jam operasional untuk pembayaran tunai',
                    'contact_phone': 'Nomor telepon kontak',
                    'contact_email': 'Email kontak perusahaan',
                    'contact_address': 'Alamat perusahaan',
                    'contact_whatsapp': 'Nomor WhatsApp kontak',
                    'whatsapp_rate_limit.maxMessagesPerBatch': 'Maksimal pesan per batch WhatsApp',
                    'whatsapp_rate_limit.delayBetweenBatches': 'Jeda antar batch pesan (detik)',
                    'whatsapp_rate_limit.delayBetweenMessages': 'Jeda antar pesan individual (detik)',
                    'whatsapp_rate_limit.maxRetries': 'Maksimal percobaan ulang jika gagal',
                    'whatsapp_rate_limit.dailyMessageLimit': 'Batas pesan harian (0 = tidak terbatas)',
                    'whatsapp_rate_limit.enabled': 'Aktifkan pembatasan tingkat pesan WhatsApp',
                    'telegram_bot.enabled': 'Aktifkan integrasi Telegram Bot untuk admin dan teknisi',
                    'telegram_bot.bot_token': 'Token bot yang didapat dari @BotFather di Telegram',
                    'telegram_bot.session_timeout_hours': 'Masa berlaku sesi login di bot Telegram',
                    'telegram_bot.auto_session_cleanup': 'Bersihkan sesi yang sudah kadaluarsa secara otomatis',
                    'telegram_bot.allowed_users': 'Daftar role yang diizinkan menggunakan bot (contoh: admin, technician)',
                    'telegram_bot.notification_settings.enable_notifications': 'Kirim notifikasi sistem ke Telegram',
                    'telegram_bot.notification_settings.error_notifications': 'Kirim pemberitahuan error ke Telegram',
                    'telegram_bot.notification_settings.command_logging': 'Simpan log setiap perintah yang dijalankan melalui bot',
                    'telegram_bot.mikrotik_settings.auto_comment_enabled': 'Tambahkan komentar otomatis saat membuat user di MikroTik',
                    'telegram_bot.mikrotik_settings.comment_format': 'Format komentar untuk user MikroTik (gunakan placeholder: {username}, {date}, {time}, {creator})',
                    'telegram_bot.mikrotik_settings.session_management_enabled': 'Putuskan sesi aktif secara otomatis saat profil user berubah'
                };
                return descriptions[key] || '';
            }
            // Ambil data settings.json
            $.get('/admin/settings/data', function (data) {
                var html = '';
                function renderField(key, val) {
                    if (hiddenFields.includes(key)) return; // Sembunyikan field tertentu
                    if (typeof val === 'object' && val !== null) {
                        Object.keys(val).forEach(function (subkey) {
                            renderField(key + '.' + subkey, val[subkey]);
                        });
                    } else {
                        html += '<div class="mb-3">';
                        if (key === 'user_auth_mode') {
                            var fieldDescription = getFieldDescription(key);
                            html += '<label class="form-label">Mode Autentikasi User</label>';

                            // Tambahkan keterangan jika tersedia
                            if (fieldDescription) {
                                html += '<div class="form-text text-muted mb-2">' + fieldDescription + '</div>';
                            }

                            html += '<div class="form-check">';
                            html += '<input class="form-check-input" type="radio" name="user_auth_mode" id="auth_mode_mikrotik" value="mikrotik"' + (val === "mikrotik" ? " checked" : "") + '> ';
                            html += '<label class="form-check-label" for="auth_mode_mikrotik">Mikrotik (RouterOS API)</label>';
                            html += '</div>';
                            html += '<div class="form-check">';
                            html += '<input class="form-check-input" type="radio" name="user_auth_mode" id="auth_mode_radius" value="radius"' + (val === "radius" ? " checked" : "") + '> ';
                            html += '<label class="form-check-label" for="auth_mode_radius">RADIUS (Database RADIUS)</label>';
                            html += '</div>';
                        } else if (typeof val === 'boolean' || val === true || val === false || val === 'true' || val === 'false') {
                            var checked = (val === true || val === 'true') ? 'checked' : '';
                            var fieldLabel = getFieldLabel(key);
                            var fieldDescription = getFieldDescription(key);
                            html += '<label class="form-label">' + fieldLabel + '</label>';

                            // Tambahkan keterangan jika tersedia
                            if (fieldDescription) {
                                html += '<div class="form-text text-muted mb-2">' + fieldDescription + '</div>';
                            }

                            html += '<div class="form-check">';
                            html += '<input class="form-check-input" type="checkbox" name="' + key + '" id="setting_' + key + '" ' + checked + '> ';
                            html += '<label class="form-check-label" for="setting_' + key + '">' + (checked ? 'Aktif' : 'Tidak Aktif') + '</label>';
                            html += '</div>';
                        } else {
                            var fieldLabel = getFieldLabel(key);
                            var fieldDescription = getFieldDescription(key);
                            html += '<label class="form-label">' + fieldLabel + '</label>';

                            // Tambahkan keterangan jika tersedia
                            if (fieldDescription) {
                                html += '<div class="form-text text-muted mb-2">' + fieldDescription + '</div>';
                            }

                            if (key === 'suspension_grace_period_days') {
                                html += '<input type="number" class="form-control" name="' + key + '" value="' + val + '" min="1" max="365">';
                            } else if (key === 'tax_settings.default_tax_rate') {
                                html += '<input type="number" class="form-control" name="' + key + '" value="' + val + '" step="0.01" min="0" max="100">';
                            } else if (key === 'tax_settings.tax_name') {
                                html += '<input type="text" class="form-control" name="' + key + '" value="' + val + '">';
                            } else if (key === 'tax_settings.tax_enabled') {
                                var checked = (val === true || val === 'true') ? 'checked' : '';
                                html += '<div class="form-check">';
                                html += '<input class="form-check-input" type="checkbox" name="' + key + '" id="setting_' + key + '" ' + checked + '> ';
                                html += '<label class="form-check-label" for="setting_' + key + '">' + (checked ? 'Aktif' : 'Tidak Aktif') + '</label>';
                                html += '</div>';
                            } else if (key === 'tax_settings.tax_inclusive') {
                                var checked = (val === true || val === 'true') ? 'checked' : '';
                                html += '<div class="form-check">';
                                html += '<input class="form-check-input" type="checkbox" name="' + key + '" id="setting_' + key + '" ' + checked + '> ';
                                html += '<label class="form-check-label" for="setting_' + key + '">' + (checked ? 'Ya' : 'Tidak') + '</label>';
                                html += '</div>';
                                html += '<div class="form-text">Harga paket sudah termasuk PPN (tax inclusive) atau belum (tax exclusive)</div>';
                            } else if (key.includes('password') || key.includes('Password') || key.includes('token')) {
                                // Field password - gunakan input type="password"
                                html += '<input type="password" class="form-control" name="' + key + '" value="' + val + '" placeholder="Masukkan password">';
                                html += '<div class="form-text text-warning">⚠️ Hati-hati saat mengubah password. Pastikan password benar untuk menghindari error koneksi.</div>';
                            } else {
                                html += '<input type="text" class="form-control" name="' + key + '" value="' + val + '">';
                            }
                        }
                        html += '</div>';
                    }
                }
                Object.keys(data).forEach(function (key) {
                    renderField(key, data[key]);
                });
                $('#settingsFields').html(html);
            });
            // Submit form settings
            $('#settingsForm').on('submit', function (e) {
                e.preventDefault();

                // Disable submit button untuk mencegah multiple submission
                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Menyimpan...');

                var formData = {};
                var hasChanges = false;

                // Handle semua input text dan checkbox
                $('#settingsForm').find('input[type=text],input[type=checkbox],input[type=number],input[type=password]').each(function () {
                    var name = $(this).attr('name');
                    if (!name) return;

                    let value;
                    if ($(this).attr('type') === 'checkbox') {
                        value = $(this).is(':checked');
                    } else {
                        value = $(this).val();
                    }

                    formData[name] = value;
                    hasChanges = true;
                });

                // Handle radio button (hanya yang checked)
                $('#settingsForm').find('input[type=radio]:checked').each(function () {
                    var name = $(this).attr('name');
                    if (!name) return;
                    formData[name] = $(this).val();
                    hasChanges = true;
                });

                // Validasi apakah ada perubahan
                if (!hasChanges || Object.keys(formData).length === 0) {
                    $('#settingsSuccess').removeClass('d-none').addClass('alert-warning').text('Tidak ada perubahan untuk disimpan.');
                    setTimeout(function () {
                        $('#settingsSuccess').addClass('d-none').removeClass('alert-warning');
                    }, 3000);
                    submitBtn.prop('disabled', false).html(originalText);
                    return;
                }

                $.ajax({
                    url: '/admin/settings/save',
                    method: 'POST',
                    data: formData,
                    timeout: 10000, // 10 detik timeout
                    success: function (res) {
                        if (res.success) {
                            $('#settingsSuccess').removeClass('d-none').text(res.message || 'Pengaturan berhasil disimpan!');
                            setTimeout(function () {
                                $('#settingsSuccess').addClass('d-none');
                            }, 3000);
                        } else {
                            $('#settingsSuccess').removeClass('d-none').addClass('alert-danger').text(res.error || 'Gagal menyimpan pengaturan!');
                            setTimeout(function () {
                                $('#settingsSuccess').addClass('d-none').removeClass('alert-danger');
                            }, 5000);
                        }
                    },
                    error: function (xhr, status, error) {
                        let errorMsg = 'Gagal menyimpan pengaturan!';

                        if (status === 'timeout') {
                            errorMsg = 'Request timeout. Silakan coba lagi.';
                        } else if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        } else if (xhr.status === 500) {
                            errorMsg = 'Terjadi kesalahan server. Silakan coba lagi.';
                        } else if (xhr.status === 400) {
                            errorMsg = 'Data tidak valid. Silakan periksa input Anda.';
                        } else if (xhr.status === 0) {
                            errorMsg = 'Tidak dapat terhubung ke server. Periksa koneksi Anda.';
                        }

                        $('#settingsSuccess').removeClass('d-none').addClass('alert-danger').text(errorMsg);
                        setTimeout(function () {
                            $('#settingsSuccess').addClass('d-none').removeClass('alert-danger');
                        }, 5000);
                    },
                    complete: function () {
                        // Re-enable submit button
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });
            // WhatsApp QR & Status
            function loadWAStatus() {
                $.ajax({
                    url: '/admin/settings/wa-status',
                    method: 'GET',
                    dataType: 'json',
                    success: function (res) {
                        console.log('WA Status Response:', res); // Debug log

                        // Update status koneksi
                        if (res.connected) {
                            let statusHtml = '<span class="badge bg-success status-badge"><i class="bi bi-check-circle"></i> Terhubung';
                            if (res.phoneNumber) {
                                statusHtml += ` (${res.phoneNumber})`;
                            }
                            if (res.connectedSince) {
                                const connectedDate = new Date(res.connectedSince);
                                statusHtml += `<br><small>Terhubung sejak: ${connectedDate.toLocaleString()}</small>`;
                            }
                            statusHtml += '</span>';
                            $('#wa-status').html(statusHtml);
                            $('#wa-qr-container').addClass('d-none');
                        } else {
                            $('#wa-status').html('<span class="badge bg-warning text-dark status-badge"><i class="bi bi-exclamation-triangle"></i> Belum Terhubung</span>');

                            // Tampilkan QR code jika tersedia
                            if (res.qr) {
                                console.log('QR Code received, length:', res.qr.length);
                                $('#wa-qr-container').removeClass('d-none');

                                // Hapus QR lama jika ada
                                $('#wa-qr').attr('src', '').hide();
                                const qrDiv = $('#wa-qr-div');
                                qrDiv.empty().show();

                                try {
                                    // Coba buat QR code langsung
                                    new QRCode(qrDiv[0], {
                                        text: res.qr,
                                        width: 220,
                                        height: 220,
                                        colorDark: '#000000',
                                        colorLight: '#ffffff',
                                        correctLevel: 2
                                    });
                                    console.log('QR Code generated successfully');
                                } catch (e) {
                                    console.error('Error generating QR code:', e);
                                    // Fallback: area kosong saja, tidak tampilkan pesan apapun
                                    qrDiv.html("");
                                }
                            } else {
                                console.log('No QR code received from server');
                                $('#wa-qr-container').addClass('d-none');
                                if (res.error) {
                                    $('#wa-status').append(`<div class="alert alert-danger mt-2">${res.error}</div>`);
                                }
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error getting WhatsApp status:', error);
                        const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : error;
                        $('#wa-status').html(`
                    <span class="badge bg-danger status-badge">
                        <i class="bi bi-x-circle"></i> Gagal memuat status
                    </span>
                    <div class="alert alert-danger mt-2">${errorMsg || 'Tidak dapat terhubung ke server'}</div>
                `);
                        $('#wa-qr-container').addClass('d-none');
                    }
                });
            }
            loadWAStatus();
            $('#btnRefreshQR').on('click', function (e) {
                e.preventDefault();
                $.post('/admin/settings/wa-refresh', function () {
                    loadWAStatus();
                });
            });
            $('#btnDeleteSession').on('click', function (e) {
                e.preventDefault();
                if (confirm('Yakin hapus sesi WhatsApp?')) {
                    $.post('/admin/settings/wa-delete', function () {
                        loadWAStatus();
                    });
                }
            });
            // Auto refresh status tiap 10 detik
            setInterval(loadWAStatus, 10000);

            // ===== TELEGRAM BOT FUNCTIONS =====
            function loadTGStatus() {
                $.ajax({
                    url: '/admin/settings/tg-status',
                    method: 'GET',
                    success: function (res) {
                        if (res.active) {
                            $('#tg-status').html('<span class="badge bg-success status-badge"><i class="bi bi-check-circle"></i> Bot Aktif</span>');

                            // Load statistics
                            if (res.statistics) {
                                $('#tg-stats').show();
                                $('#tg-total-users').text(res.statistics.total);
                                $('#tg-active-sessions').text(res.statistics.active);
                            }
                        } else {
                            if (res.isConfigured) {
                                $('#tg-status').html('<span class="badge bg-warning text-dark status-badge"><i class="bi bi-exclamation-triangle"></i> Terkonfigurasi - Bot Mati</span>');
                            } else {
                                $('#tg-status').html('<span class="badge bg-danger status-badge"><i class="bi bi-x-circle"></i> Belum Terkonfigurasi</span>');
                            }
                            $('#tg-stats').hide();
                        }
                    },
                    error: function (xhr) {
                        $('#tg-status').html('<span class="badge bg-danger status-badge"><i class="bi bi-x-circle"></i> Error Memuat Status</span>');
                    }
                });
            }

            // Initial load and interval
            loadTGStatus();
            setInterval(loadTGStatus, 15000); // 15 detik sekali

            // Restart Bot button
            $('#btnRestartBot').on('click', function (e) {
                e.preventDefault();
                if (!confirm('Yakin ingin me-restart Telegram Bot?')) return;

                const btn = $(this);
                const originalText = btn.html();
                btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Restarting...');

                $.post('/admin/settings/tg-restart', function (res) {
                    if (res.success) {
                        showNotification('success', 'Telegram Bot berhasil di-restart');
                        // Reload status after delay
                        setTimeout(loadTGStatus, 3000);
                    } else {
                        showNotification('danger', 'Gagal me-restart Telegram Bot: ' + res.error);
                    }
                }).fail(function (xhr) {
                    showNotification('danger', 'Gagal me-restart Telegram Bot');
                }).always(function () {
                    btn.prop('disabled', false).html(originalText);
                });
            });
        });
    </script>
    <script>
        // Optical Splitter Attenuation Calculator Logic
        $(function () {
            // Standar losses
            const fiberLossPerKm = 0.35;
            const connectorLoss = 0.5;
            const spliceLoss = 0.1;

            function calcAttenuation(N) {
                return +(10 * Math.log10(N)).toFixed(2);
            }
            function getTotalLoss() {
                const fiberLength = parseFloat($('#fiberLength').val()) || 0;
                const connectorCount = parseInt($('#connectorCount').val()) || 0;
                const spliceCount = parseInt($('#spliceCount').val()) || 0;
                const margin = parseFloat($('#margin').val()) || 0;
                return +(fiberLength * fiberLossPerKm + connectorCount * connectorLoss + spliceCount * spliceLoss + margin).toFixed(2);
            }
            function updateSplitterCalc() {
                const rxAwal = parseFloat($('#rxAwal').val());
                const ratio = parseInt($('#splitterRatio').val());
                if (isNaN(rxAwal) || isNaN(ratio)) {
                    $('#splitterAttenuation').val('');
                    $('#rxSetelahSplitter').val('');
                    return false;
                }
                const att = calcAttenuation(ratio);
                const totalLoss = getTotalLoss();
                const rxAfter = +(rxAwal - att - totalLoss).toFixed(2);
                $('#splitterAttenuation').val((att + totalLoss).toFixed(2));
                $('#rxSetelahSplitter').val(rxAfter);
                return true;
            }
            function updateSplitterTable() {
                const rxAwal = parseFloat($('#rxAwal').val());
                const fiberLength = parseFloat($('#fiberLength').val()) || 0;
                const connectorCount = parseInt($('#connectorCount').val()) || 0;
                const spliceCount = parseInt($('#spliceCount').val()) || 0;
                const margin = parseFloat($('#margin').val()) || 0;
                const ratios = [2, 4, 8, 16, 32, 64];
                let html = '';
                ratios.forEach(function (r) {
                    const att = calcAttenuation(r);
                    const totalLoss = fiberLength * fiberLossPerKm + connectorCount * connectorLoss + spliceCount * spliceLoss + margin;
                    let rxAfter = '';
                    if (!isNaN(rxAwal)) rxAfter = (rxAwal - att - totalLoss).toFixed(2);
                    html += `<tr><td>1:${r}</td><td>${(att + totalLoss).toFixed(2)}</td><td>${rxAfter}</td></tr>`;
                });
                $('#splitterTableBody').html(html);
            }
            // Hide result section by default
            $('#splitterResultSection').hide();
            // Only generate on button click
            $('#generateSplitterResult').on('click', function () {
                const valid = updateSplitterCalc();
                if (valid) {
                    updateSplitterTable();
                    $('#splitterResultSection').slideDown();
                } else {
                    $('#splitterResultSection').slideUp();
                }
            });
        });
    </script>
    <script>
        // Fungsi untuk download file
        function downloadScript(filename, content) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // VPS & MikroTik Configuration Generator
        function generateVpsScript() {
            const vpsIp = $('#vpsPublicIp').val().trim();
            const vpsInterface = $('#vpsInterface').val().trim();
            const wgPort = $('#wgPort').val().trim();
            const vpsLocalIp = $('#vpsLocalIp').val().trim();
            const networkSubnet = $('#networkSubnet').val().trim();

            if (!vpsIp || !vpsInterface || !wgPort || !vpsLocalIp || !networkSubnet) {
                alert('Harap isi semua field yang diperlukan');
                return;
            }

            const script = `#!/bin/bash
# ===========================================
# Script Konfigurasi VPS untuk WireGuard
# ===========================================

# Update sistem
echo "Mengupdate sistem..."
sudo apt update && sudo apt upgrade -y

# Install paket yang diperlukan
echo "Menginstall paket yang diperlukan..."
sudo apt install -y wireguard net-tools iputils-ping

# Generate key
echo "Membuat kunci WireGuard..."
umask 077
wg genkey | sudo tee /etc/wireguard/private.key
sudo cat /etc/wireguard/private.key | wg pubkey | sudo tee /etc/wireguard/public.key

# Buat konfigurasi WireGuard
echo "Membuat konfigurasi WireGuard..."
sudo cat > /etc/wireguard/wg0.conf <<EOL
[Interface]
Address = ${vpsLocalIp}/24
SaveConfig = true
ListenPort = ${wgPort}
PrivateKey = $(sudo cat /etc/wireguard/private.key)
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ${vpsInterface} -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ${vpsInterface} -j MASQUERADE
EOL

# Aktifkan IP forwarding
echo "Mengaktifkan IP forwarding..."
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# Konfigurasi firewall
echo "Mengkonfigurasi firewall..."
sudo ufw allow 22/tcp
sudo ufw allow ${wgPort}/udp

# Konfigurasi NAT untuk WireGuard
sudo sed -i '/^\*filter$/i *nat\n:POSTROUTING ACCEPT [0:0]\n-A POSTROUTING -s ${networkSubnet} -o ${vpsInterface} -j MASQUERADE\nCOMMIT\n' /etc/ufw/before.rules

# Aktifkan firewall
sudo ufw enable

# Start WireGuard
echo "Menjalankan WireGuard..."
sudo systemctl enable --now wg-quick@wg0

echo "\n==========================================="
echo "Konfigurasi VPS selesai!"
echo "Gunakan public key berikut untuk konfigurasi MikroTik:"
sudo cat /etc/wireguard/public.key
echo "\n==========================================="`;

            $('#generatedScript').text(script);
            return script;
        }

        function generateMikrotikScript() {
            const vpsIp = $('#vpsPublicIp').val().trim();
            const wgPort = $('#wgPort').val().trim();
            const mikrotikLocalIp = $('#mikrotikLocalIp').val().trim();
            const vpsLocalIp = $('#vpsLocalIp').val().trim();
            const networkSubnet = $('#networkSubnet').val().trim();

            if (!vpsIp || !wgPort || !mikrotikLocalIp || !vpsLocalIp || !networkSubnet) {
                alert('Harap isi semua field yang diperlukan');
                return;
            }

            const script = `# ===========================================
# Script Konfigurasi MikroTik untuk WireGuard
# ===========================================

# Generate key pair
:local privateKey ""
:local publicKey ""
/interface wireguard keypair \
    private-key=private.key public-key=public.key
:set privateKey [:parse [/file get private.key contents]]
:set publicKey [:parse [/file get public.key contents]]
/file remove public.key private.key

# Buat interface WireGuard
/interface wireguard add \
    name=wg-vps \
    private-key=$privateKey \
    listen-port=${wgPort}

# Tambahkan peer (VPS)
/interface wireguard peers add \
    interface=wg-vps \
    public-key="<MASUKKAN_PUBLIC_KEY_VPS>" \
    allowed-address=${vpsLocalIp}/32 \
    endpoint-address=${vpsIp} \
    endpoint-port=${wgPort}

# Atur IP lokal
/ip address add \
    address=${mikrotikLocalIp}/24 \
    interface=wg-vps

# Tambahkan rute ke VPS
/ip route add \
    dst-address=${vpsLocalIp}/32 \
    gateway=wg-vps

# Tambahkan rute ke jaringan lokal VPS (jika ada)
/ip route add \
    dst-address=${networkSubnet} \
    gateway=wg-vps

# Konfigurasi NAT (jika diperlukan)
/ip firewall nat add \
    chain=srcnat \
    out-interface=wg-vps \
    action=masquerade

# Konfigurasi DHCP Option 43 untuk GenieACS
:local genieAcsUrl "http://${vpsLocalIp}:7547"
:local urlHex [:pick [/tool fetch url="http://text-processing.com/encode/raw/" \
    http-method=post \
    http-data="text=$genieAcsUrl&encode=hex&charset=utf-8" \
    as-value output=user] 1]
:local urlLen [:len $urlHex]
:local option43 "01$[:pick $urlHex 0 2]$[:pick $urlHex 2 $urlLen]"

/ip dhcp-server option add name=opt43 code=43 value="0x$option43"
/ip dhcp-server network set numbers=0 dhcp-option=opt43

:put "==========================================="
:put "Konfigurasi MikroTik selesai!"
:put "Gunakan public key ini di VPS:"
:put $publicKey
:put "\n==========================================="`;

            $('#generatedScript').text(script);
            return script;
        }

        // Event Listeners
        let currentVpsScript = '';
        let currentMikrotikScript = '';

        $('#generateVpsScript').on('click', function () {
            currentVpsScript = generateVpsScript();
            $('#downloadVpsScript').prop('disabled', false);
        });

        $('#generateMikrotikScript').on('click', function () {
            currentMikrotikScript = generateMikrotikScript();
            $('#downloadMikrotikScript').prop('disabled', false);
        });

        $('#downloadVpsScript').on('click', function () {
            if (currentVpsScript) {
                downloadScript('vps-wireguard-setup.sh', currentVpsScript);
            }
        });

        $('#downloadMikrotikScript').on('click', function () {
            if (currentMikrotikScript) {
                downloadScript('mikrotik-wireguard-setup.rsc', currentMikrotikScript);
            }
        });
    </script>

    <script>
        $(function () {
            $(document).on('click', '#restartMikrotikBtn', function (e) {
                e.preventDefault();
                $('#restartMikrotikModal').modal('show');
            });
            $('#confirmRestartMikrotik').on('click', function () {
                $('#restartMikrotikModal').modal('hide');
                $.ajax({
                    url: '/admin/mikrotik/restart',
                    method: 'POST',
                    success: function (res) {
                        let notif = $('#restartNotif');
                        if (res.success) {
                            notif.removeClass('d-none alert-danger').addClass('alert-success').text(res.message || 'Mikrotik berhasil direstart!');
                        } else {
                            notif.removeClass('d-none alert-success').addClass('alert-danger').text(res.message || 'Gagal restart Mikrotik!');
                        }
                        setTimeout(function () { notif.addClass('d-none'); }, 4000);
                    },
                    error: function () {
                        let notif = $('#restartNotif');
                        notif.removeClass('d-none alert-success').addClass('alert-danger').text('Gagal menghubungi server!');
                        setTimeout(function () { notif.addClass('d-none'); }, 4000);
                    }
                });
            });
        });

    </script>


    <script>
        $(document).ready(function () {
            // 1. Handle Logo Upload
            $('#logoUploadForm').on('submit', function (e) {
                e.preventDefault();

                var formData = new FormData(this);

                $.ajax({
                    url: '/admin/settings/upload-logo',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            // Tampilkan notifikasi sukses
                            showNotification('success', 'Logo berhasil diupload! Halaman akan dimuat ulang...');

                            // Tunggu 1.5 detik lalu refresh halaman
                            setTimeout(function () {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showNotification('danger', response.error || 'Gagal mengupload logo');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error uploading logo:', error);
                        var errorMsg = 'Terjadi kesalahan saat mengupload logo';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        showNotification('danger', errorMsg);
                    }
                });
            });

            // 2. Handle DHCP Option 43 Generator
            $('#generateOption43').on('click', function () {
                const url = $('#genieacsUrl').val().trim();

                if (!url) {
                    showNotification('warning', 'Masukkan URL GenieACS terlebih dahulu');
                    return;
                }

                try {
                    // Format URL untuk DHCP Option 43
                    // Format: 01<panjang url dalam hex><url dalam hex>
                    const urlHex = stringToHex(url);
                    const urlLenHex = (urlHex.length / 2).toString(16).padStart(2, '0');
                    const option43 = '01' + urlLenHex + urlHex;

                    // Tampilkan hasil
                    $('#option43Result').val(option43);
                    $('#option43Value').text(option43);

                    // Sembunyikan notifikasi error jika ada
                    $('#option43Error').addClass('d-none');
                } catch (e) {
                    console.error('Error generating Option 43:', e);
                    $('#option43Error').removeClass('d-none').text('Gagal menghasilkan Option 43: ' + e.message);
                }
            });

            // Fungsi untuk menyalin teks ke clipboard
            $('#copyOption43Btn').on('click', function () {
                const copyText = document.getElementById("option43Result");
                copyText.select();
                copyText.setSelectionRange(0, 99999); // Untuk mobile
                document.execCommand("copy");
                showNotification('success', 'Tersalin ke clipboard!');
            });

            // Fungsi bantu: Konversi string ke hex
            function stringToHex(str) {
                let hex = '';
                for (let i = 0; i < str.length; i++) {
                    hex += str.charCodeAt(i).toString(16).padStart(2, '0');
                }
                return hex;
            }

            // Fungsi untuk menampilkan notifikasi
            function showNotification(type, message) {
                const notif = $('<div>')
                    .addClass('alert alert-' + type + ' alert-dismissible fade show position-fixed top-0 end-0 m-3')
                    .css('z-index', '1055')
                    .html(`
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `);

                $('body').append(notif);

                // Hapus notifikasi setelah 5 detik
                setTimeout(() => {
                    notif.alert('close');
                }, 5000);
            }

            // 3. Handle Mikrotik Isolation Script Generator
            $('#generateIsolationScript').on('click', function () {
                const method = $('#isolationMethod').val();
                const bandwidthLimit = $('#bandwidthLimit').val();
                const networkRange = $('#networkRange').val();
                const dnsServers = $('#dnsServers').val();

                // Validasi input
                if (!networkRange) {
                    showNotification('warning', 'Masukkan network range terlebih dahulu');
                    return;
                }

                // Tampilkan loading
                $('#generateIsolationScript').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Generating...');

                // Kirim request ke server
                $.ajax({
                    url: '/admin/settings/generate-isolation-script',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        method: method,
                        bandwidthLimit: bandwidthLimit,
                        networkRange: networkRange,
                        dnsServers: dnsServers
                    }),
                    success: function (response) {
                        if (response.success) {
                            $('#isolationScriptResult').val(response.script);
                            showNotification('success', 'Script berhasil di-generate!');
                        } else {
                            showNotification('danger', 'Gagal generate script: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error generating script:', error);
                        showNotification('danger', 'Error: ' + error);
                    },
                    complete: function () {
                        $('#generateIsolationScript').prop('disabled', false).html('<i class="bi bi-gear"></i> Generate Script');
                    }
                });
            });

            // Preview script
            $('#previewIsolationScript').on('click', function () {
                const script = $('#isolationScriptResult').val();
                if (!script) {
                    showNotification('warning', 'Generate script terlebih dahulu');
                    return;
                }

                // Buka modal preview
                $('#scriptPreviewModal .modal-body pre').text(script);
                new bootstrap.Modal(document.getElementById('scriptPreviewModal')).show();
            });

            // Copy script to clipboard
            $('#copyIsolationScriptBtn').on('click', function () {
                const copyText = document.getElementById("isolationScriptResult");
                copyText.select();
                copyText.setSelectionRange(0, 99999); // Untuk mobile
                document.execCommand("copy");
                showNotification('success', 'Script tersalin ke clipboard!');
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            // 1. Handle Burst Limit Calculator
            $('#generateBurstLimit').on('click', function () {
                // Ambil nilai input
                const uploadRate = $('#uploadRate').val();
                const uploadUnit = $('#uploadUnit').val();
                const downloadRate = $('#downloadRate').val();
                const downloadUnit = $('#downloadUnit').val();
                const uploadBurstRate = $('#uploadBurstRate').val();
                const uploadBurstUnit = $('#uploadBurstUnit').val();
                const downloadBurstRate = $('#downloadBurstRate').val();
                const downloadBurstUnit = $('#downloadBurstUnit').val();
                const burstTime = $('#burstTime').val() || '8';

                // Validasi input
                if (!uploadRate || !downloadRate || !uploadBurstRate || !downloadBurstRate) {
                    showNotification('warning', 'Harap isi semua field yang diperlukan');
                    return;
                }

                // Format rate limit
                const formatRate = (rate, unit) => {
                    if (unit === 'M') {
                        return `${rate}M`;
                    } else {
                        return rate === '0' ? '0' : `${rate}K`;
                    }
                };

                // Format burst limit
                const formatBurst = (rate, unit, burstRate, burstUnit) => {
                    if (rate === '0') return '0/0';

                    const rateValue = parseInt(rate);
                    const burstValue = parseInt(burstRate);
                    let rateKbps = unit === 'M' ? rateValue * 1000 : rateValue;
                    let burstKbps = burstUnit === 'M' ? burstValue * 1000 : burstValue;

                    // Hitung burst threshold (50-75% dari burst rate)
                    const threshold = Math.max(
                        Math.min(Math.ceil(burstKbps * 0.75), burstKbps - 1),
                        Math.ceil(burstKbps * 0.5)
                    );

                    return `${burstKbps}K/${threshold}K ${burstTime}`;
                };

                // Generate hasil
                const uploadLimit = formatRate(uploadRate, uploadUnit);
                const downloadLimit = formatRate(downloadRate, downloadUnit);
                const uploadBurst = formatBurst(uploadRate, uploadUnit, uploadBurstRate, uploadBurstUnit);
                const downloadBurst = formatBurst(downloadRate, downloadUnit, downloadBurstRate, downloadBurstUnit);

                // Format hasil untuk MikroTik
                const result =
                    `/ip hotspot user profile set [find name="NamaProfil"] \
    rate-limit="${uploadLimit}/${downloadLimit}" \
    burst-limit="${uploadBurst}/${downloadBurst}" \
    burst-threshold=0/0 \
    burst-time=0s/0s`;

                // Tampilkan hasil
                $('#burstResult').val(result);

                // Scroll ke hasil
                $('html, body').animate({
                    scrollTop: $('#burstResult').offset().top - 100
                }, 500);
            });

            // 2. Handle Copy to Clipboard
            $('#copyBurstBtn').on('click', function () {
                const copyText = document.getElementById("burstResult");
                copyText.select();
                copyText.setSelectionRange(0, 99999);
                document.execCommand("copy");
                showNotification('success', 'Berhasil disalin ke clipboard!');
            });
        });

        // 2. WhatsApp Groups Management
        let currentGroups = [];

        // Load WhatsApp Groups
        $('#btnLoadGroups, #btnRefreshGroups').on('click', function () {
            loadWhatsAppGroups();
        });

        async function loadWhatsAppGroups() {
            try {
                $('#btnLoadGroups, #btnRefreshGroups').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Loading...');

                console.log('🔄 Loading WhatsApp groups...');

                const response = await fetch('/admin/settings/whatsapp-groups', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // If not JSON, read as text to see what we got
                    const textResponse = await response.text();
                    console.error('Received non-JSON response:', textResponse.substring(0, 500));
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }

                const data = await response.json();
                console.log('📊 API Response:', data);

                if (data.success) {
                    currentGroups = data.groups;
                    displayGroups(data.groups);
                    $('#waGroupsStatus').html(`<div class="alert alert-success"><i class="bi bi-check-circle"></i> Berhasil memuat ${data.total} grup WhatsApp</div>`);
                    $('#waGroupsList').show();
                } else {
                    $('#waGroupsStatus').html(`<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${data.message || 'Gagal memuat grup WhatsApp'}</div>`);
                    $('#waGroupsList').hide();
                }
            } catch (error) {
                console.error('❌ Error loading WhatsApp groups:', error);

                let errorMessage = error.message;
                if (error.message.includes('Unexpected token')) {
                    errorMessage = 'Server mengembalikan response yang tidak valid. Pastikan WhatsApp sudah terkoneksi.';
                } else if (error.message.includes('HTTP 404')) {
                    errorMessage = 'Endpoint tidak ditemukan. Pastikan aplikasi berjalan dengan benar.';
                } else if (error.message.includes('HTTP 500')) {
                    errorMessage = 'Server error. Cek logs aplikasi untuk detail error.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Tidak dapat terhubung ke server. Pastikan aplikasi berjalan.';
                }

                $('#waGroupsStatus').html(`<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${errorMessage}</div>`);
                $('#waGroupsList').hide();
            } finally {
                $('#btnLoadGroups').prop('disabled', false).html('<i class="bi bi-arrow-clockwise"></i> Load Groups');
                $('#btnRefreshGroups').prop('disabled', false).html('<i class="bi bi-refresh"></i> Refresh');
            }
        }

        function displayGroups(groups) {
            const container = $('#groupsContainer');
            const countBadge = $('#groupsCount');

            console.log('📱 Displaying', groups.length, 'groups');

            countBadge.text(groups.length);

            if (groups.length === 0) {
                container.html('<div class="p-4 text-center text-muted"><i class="bi bi-info-circle"></i><br>Tidak ada grup WhatsApp ditemukan</div>');
                return;
            }

            let html = '<div class="list-group list-group-flush">';

            groups.forEach((group, index) => {
                const adminIcon = group.isAdmin ? '<i class="bi bi-star-fill text-warning ms-1" title="Admin"></i>' : '';
                const badgeClass = group.isAdmin ? 'bg-success' : 'bg-secondary';
                const groupId = group.id || '';

                console.log(`   Grup ${index + 1}: ${group.name} (${groupId})`);

                html += `
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <strong>${group.name}</strong>${adminIcon}
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-people"></i> ${group.participants} anggota |
                            <i class="bi bi-calendar"></i> ${group.created}
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary view-group-btn"
                                data-group-id="${groupId}"
                                title="Detail Grup">
                            <i class="bi bi-eye"></i> Detail
                        </button>
                        <button class="btn btn-sm btn-outline-secondary copy-group-btn"
                                data-group-id="${groupId}"
                                title="Copy Group ID">
                            <i class="bi bi-clipboard"></i> Copy ID
                        </button>
                    </div>
                </div>
            `;
            });

            html += '</div>';
            container.html(html);

            // Add event listeners after HTML is inserted
            attachGroupButtonListeners();
        }

        function attachGroupButtonListeners() {
            console.log('🔧 Attaching group button listeners...');

            // View Group Detail buttons
            $('.view-group-btn').on('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const groupId = $(this).data('group-id');
                console.log('👁️ View button clicked for group:', groupId);
                if (groupId) {
                    viewGroupDetail(groupId);
                }
            });

            // Copy Group ID buttons
            $('.copy-group-btn').on('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const groupId = $(this).data('group-id');
                console.log('📋 Copy button clicked for group:', groupId);
                if (groupId) {
                    copyGroupId(groupId);
                }
            });

            console.log('✅ Group button listeners attached');
        }

        // View Group Detail
        async function viewGroupDetail(groupId) {
            try {
                const response = await fetch(`/admin/settings/whatsapp-groups/${groupId}`);
                const data = await response.json();

                if (data.success) {
                    const group = data.group;
                    const participantsHtml = group.participants.map(p => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${p.id.split('@')[0]}
                        ${p.isAdmin ? '<span class="badge bg-success">Admin</span>' : ''}
                        ${p.isSuperAdmin ? '<span class="badge bg-warning">Super Admin</span>' : ''}
                    </li>
                `).join('');

                    const html = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6><i class="bi bi-info-circle"></i> Informasi Grup</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Nama Grup:</strong></td>
                                    <td>${group.name}</td>
                                </tr>
                                <tr>
                                    <td><strong>Group ID:</strong></td>
                                    <td><code>${group.id}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>Owner:</strong></td>
                                    <td>${group.owner}</td>
                                </tr>
                                <tr>
                                    <td><strong>Total Anggota:</strong></td>
                                    <td>${group.totalParticipants}</td>
                                </tr>
                                <tr>
                                    <td><strong>Dibuat:</strong></td>
                                    <td>${group.created}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status Admin:</strong></td>
                                    <td>${group.isAdmin ? '<span class="badge bg-success">Ya</span>' : '<span class="badge bg-secondary">Tidak</span>'}</td>
                                </tr>
                                ${group.description ? `
                                <tr>
                                    <td><strong>Deskripsi:</strong></td>
                                    <td>${group.description}</td>
                                </tr>
                                ` : ''}
                            </table>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="bi bi-people"></i> Anggota (${group.totalParticipants})</h6>
                            <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                <ul class="list-group list-group-flush">
                                    ${participantsHtml}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                    $('#groupDetailContent').html(html);
                    $('#btnCopyGroupId').attr('onclick', `copyGroupId('${group.id}')`);
                    new bootstrap.Modal(document.getElementById('groupDetailModal')).show();
                } else {
                    showNotification('danger', data.message);
                }
            } catch (error) {
                console.error('Error loading group detail:', error);
                showNotification('danger', 'Error: ' + error.message);
            }
        }

        // Copy Group ID
        function copyGroupId(groupId) {
            console.log('📋 Copying Group ID:', groupId);

            if (!groupId || groupId.trim() === '') {
                console.error('❌ Group ID is empty');
                showNotification('danger', 'Group ID tidak valid!');
                return;
            }

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(groupId).then(() => {
                    console.log('✅ Copied to clipboard using modern API');
                    showNotification('success', `Group ID berhasil disalin: ${groupId.substring(0, 20)}...`);
                }).catch(err => {
                    console.error('❌ Failed to copy with modern API:', err);
                    fallbackCopyTextToClipboard(groupId);
                });
            } else {
                console.log('⚠️ Modern clipboard API not available, using fallback');
                fallbackCopyTextToClipboard(groupId);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;

            // Avoid scrolling to bottom
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    console.log('✅ Copied to clipboard using fallback method');
                    showNotification('success', `Group ID berhasil disalin: ${text.substring(0, 20)}...`);
                } else {
                    console.error('❌ Fallback copy failed');
                    showNotification('danger', 'Gagal menyalin Group ID!');
                }
            } catch (err) {
                console.error('❌ Fallback copy error:', err);
                showNotification('danger', 'Gagal menyalin Group ID!');
            }

            document.body.removeChild(textArea);
        }

        // Handler untuk tombol Test Koneksi
        $('#testConnectionBtn').on('click', function () {
            const $btn = $(this);
            const originalText = $btn.html();

            // Loading state
            $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>Testing...');

            // Kirim request test koneksi
            $.ajax({
                url: '/admin/config/validate',
                method: 'GET',
                success: function (response) {
                    if (response.success) {
                        const results = response.data.results;
                        const summary = response.data.summary;

                        if (results && results.overall && results.overall.isValid) {
                            showNotification('success', '✅ Semua koneksi berhasil! Konfigurasi sistem valid.');
                        } else {
                            let errorMsg = '⚠️ Ditemukan masalah koneksi:\n';

                            if (results && results.genieacs && !results.genieacs.isValid) {
                                errorMsg += '• GenieACS: ' + results.genieacs.errors.join(', ') + '\n';
                            }

                            if (results && results.mikrotik && !results.mikrotik.isValid) {
                                errorMsg += '• Mikrotik: ' + results.mikrotik.errors.join(', ') + '\n';
                            }

                            errorMsg += '\nSilakan perbaiki konfigurasi dan test kembali.';

                            showNotification('warning', errorMsg);
                        }
                    } else {
                        showNotification('error', 'Gagal menjalankan test koneksi: ' + (response.message || 'Unknown error'));
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON?.message || 'Gagal menghubungi server';
                    showNotification('error', 'Error: ' + errorMsg);
                },
                complete: function () {
                    // Reset button
                    $btn.prop('disabled', false).html(originalText);
                }
            });
        });

        // ===== DNS MANAGEMENT FUNCTIONS =====

        // Test koneksi GenieACS menggunakan console script
        async function testGenieACSConnection() {
            const button = event.target.closest('button');
            setButtonLoading(button, true);
            addLog('Testing koneksi ke GenieACS...', 'info');

            try {
                // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
                const response = await fetch('/admin/settings/api/test-genieacs-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`✅ Koneksi berhasil! ${result.message}`, 'success');
                    document.getElementById('connectionStatus').innerHTML =
                        `<div class="alert alert-success">✅ Koneksi GenieACS berhasil</div>`;
                } else {
                    addLog(`❌ Koneksi gagal: ${result.message}`, 'error');
                    document.getElementById('connectionStatus').innerHTML =
                        `<div class="alert alert-danger">❌ Koneksi gagal: ${result.message}</div>`;
                }

            } catch (error) {
                addLog(`❌ Error testing koneksi: ${error.message}`, 'error');
                document.getElementById('connectionStatus').innerHTML =
                    `<div class="alert alert-danger">❌ Error: ${error.message}</div>`;
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Load device online menggunakan console script
        async function loadOnlineDevices() {
            const button = event.target.closest('button');
            setButtonLoading(button, true);
            addLog('Memuat daftar device online...', 'info');

            try {
                // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
                const response = await fetch('/admin/settings/api/get-genieacs-devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`✅ Device loaded: ${result.message}`, 'success');
                    displayDevicesFromOutput(result.output);
                    document.getElementById('deviceList').style.display = 'block';
                } else {
                    addLog(`❌ Gagal memuat device: ${result.message}`, 'error');
                }

            } catch (error) {
                addLog(`❌ Error memuat device: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Konfigurasi DNS untuk device tertentu
        async function configureDNS() {
            const deviceId = document.getElementById('deviceIdInput').value;
            const dnsServer = document.getElementById('dnsServerIp').value || '192.168.8.89';

            if (!deviceId) {
                addLog('❌ Device ID harus diisi!', 'error');
                return;
            }

            addLog(`Mengkonfigurasi DNS untuk device ${deviceId}...`, 'info');

            try {
                // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
                const response = await fetch('/admin/settings/api/configure-genieacs-dns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId,
                        dnsServer
                    })
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`✅ DNS berhasil dikonfigurasi untuk device ${deviceId}`, 'success');
                } else {
                    addLog(`❌ Gagal konfigurasi DNS: ${result.message}`, 'error');
                }

            } catch (error) {
                addLog(`❌ Error konfigurasi DNS: ${error.message}`, 'error');
            }
        }

        // Konfigurasi DNS untuk semua device online
        async function configureAllOnline() {
            const button = event.target.closest('button');
            setButtonLoading(button, true);
            addLog('Memulai konfigurasi DNS untuk semua device online...', 'info');

            try {
                // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
                const response = await fetch('/admin/settings/api/configure-all-genieacs-dns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`✅ ${result.message}`, 'success');
                } else {
                    addLog(`❌ Gagal memulai konfigurasi: ${result.message}`, 'error');
                }

            } catch (error) {
                addLog(`❌ Error memulai konfigurasi: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Display devices from console output
        function displayDevicesFromOutput(output) {
            const container = document.getElementById('deviceListContent');
            container.innerHTML = '';

            // Parse output untuk extract device info
            const lines = output.split('\n');
            let deviceCount = 0;

            lines.forEach(line => {
                if (line.includes('Device ID:') || line.includes('Serial:')) {
                    const deviceCard = document.createElement('div');
                    deviceCard.className = 'col-md-6 col-lg-4 mb-3';
                    deviceCard.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Device ${++deviceCount}</h6>
                        <p class="card-text small">${line}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="configureDeviceDNS('${line.split(':')[1]?.trim()}')">
                            <i class="bi bi-gear"></i> Konfigurasi DNS
                        </button>
                    </div>
                </div>
            `;
                    container.appendChild(deviceCard);
                }
            });
        }

        // Configure DNS for specific device
        async function configureDeviceDNS(deviceId) {
            const dnsServer = document.getElementById('dnsServerIp').value || '192.168.8.89';
            addLog(`Mengkonfigurasi DNS untuk device ${deviceId}...`, 'info');

            try {
                // Gunakan fetch untuk memanggil endpoint yang menjalankan console script
                const response = await fetch('/admin/settings/api/configure-genieacs-dns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deviceId,
                        dnsServer
                    })
                });

                const result = await response.json();

                if (result.success) {
                    addLog(`✅ DNS berhasil dikonfigurasi untuk device ${deviceId}`, 'success');
                } else {
                    addLog(`❌ Gagal konfigurasi DNS: ${result.message}`, 'error');
                }

            } catch (error) {
                addLog(`❌ Error konfigurasi DNS: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function setButtonLoading(button, loading) {
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
            } else {
                button.disabled = false;
                // Restore original text based on button class
                if (button.classList.contains('btn-outline-primary')) {
                    button.innerHTML = '<i class="bi bi-plug"></i> Test Koneksi';
                } else if (button.classList.contains('btn-outline-info')) {
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Device';
                } else if (button.classList.contains('btn-success')) {
                    button.innerHTML = '<i class="bi bi-gear"></i> Konfigurasi DNS';
                } else if (button.classList.contains('btn-warning')) {
                    button.innerHTML = '<i class="bi bi-broadcast-tower"></i> Konfigurasi Semua Online';
                }
            }
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');

            let icon = 'ℹ️';
            if (type === 'success') icon = '✅';
            else if (type === 'error') icon = '❌';
            else if (type === 'warning') icon = '⚠️';

            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${icon} ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ===== MIKROTIK DNS GENIEACS SCRIPT GENERATOR FUNCTIONS =====

        // Generate Mikrotik DNS GenieACS Script
        function generateMikrotikDNSGenieACSScript() {
            const genieacsServerIp = document.getElementById('genieacsServerIp').value.trim();
            const genieacsPort = document.getElementById('genieacsPort').value.trim() || '7547';
            const pppoeRange = document.getElementById('pppoeRange').value.trim() || '192.168.10.0/24';
            const dnsBackup = document.getElementById('dnsBackup').value.trim() || '8.8.8.8';

            if (!genieacsServerIp) {
                showNotification('warning', 'Masukkan IP Server GenieACS terlebih dahulu');
                return;
            }

            const script = generateMikrotikDNSGenieACSScriptContent(genieacsServerIp, genieacsPort, pppoeRange, dnsBackup);

            // Tampilkan script
            document.getElementById('mikrotikDNSGenieACSScriptContent').textContent = script;
            document.getElementById('mikrotikDNSGenieACSScriptOutput').style.display = 'block';

            // Enable tombol copy dan download
            document.getElementById('copyMikrotikDNSGenieACSBtn').disabled = false;
            document.getElementById('downloadMikrotikDNSGenieACSBtn').disabled = false;

            showNotification('success', 'Script Mikrotik DNS GenieACS berhasil digenerate!');
        }

        // Generate script content
        function generateMikrotikDNSGenieACSScriptContent(genieacsServerIp, genieacsPort, pppoeRange, dnsBackup) {
            const script = `# ===========================================
# MIKROTIK DNS GENIEACS CONFIGURATION SCRIPT
# ===========================================
# Generated: ${new Date().toLocaleString('id-ID')}
# GenieACS Server: ${genieacsServerIp}:${genieacsPort}
# PPPoE Range: ${pppoeRange}
# DNS Backup: ${dnsBackup}
# ===========================================

# ===========================================
# 1. SETUP DNS STATIC - Arahkan domain ke GenieACS
# ===========================================

# Hapus DNS static lama (jika ada)
/ip dns static remove [find where name="genieacs.local" and address="${genieacsServerIp}"]
/ip dns static remove [find where name="tr069.local" and address="${genieacsServerIp}"]

# Tambahkan DNS static untuk GenieACS
/ip dns static add name="genieacs.local" address="${genieacsServerIp}" ttl=300 comment="GenieACS Server"
/ip dns static add name="tr069.local" address="${genieacsServerIp}" ttl=300 comment="TR069 Server"

# ===========================================
# 2. SETUP DHCP SERVER DNS
# ===========================================

# Update DHCP server untuk memberikan DNS GenieACS
/ip dhcp-server network set [find address="${pppoeRange}"] dns-server="${genieacsServerIp},${dnsBackup}" comment="GenieACS DNS Configuration"

# ===========================================
# 3. SETUP NAT RULES - Redirect TR069 ke GenieACS
# ===========================================

# Hapus NAT rules lama (jika ada)
/ip firewall nat remove [find comment="genieacs-tr069-redirect"]
/ip firewall nat remove [find comment="genieacs-tr069-redirect-https"]

# Redirect TR069 HTTP ke GenieACS
/ip firewall nat add chain=dstnat dst-port=7547 protocol=tcp action=dst-nat to-addresses=${genieacsServerIp} to-ports=${genieacsPort} comment="genieacs-tr069-redirect"

# Redirect TR069 HTTPS ke GenieACS (jika menggunakan HTTPS)
/ip firewall nat add chain=dstnat dst-port=7548 protocol=tcp action=dst-nat to-addresses=${genieacsServerIp} to-ports=7548 comment="genieacs-tr069-redirect-https"

# ===========================================
# 4. SETUP FIREWALL RULES - Allow TR069 Communication
# ===========================================

# Hapus firewall rules lama (jika ada)
/ip firewall filter remove [find comment="genieacs-allow-tr069"]
/ip firewall filter remove [find comment="genieacs-allow-dns"]

# Allow TR069 communication dari PPPoE range ke GenieACS
/ip firewall filter add chain=forward src-address=${pppoeRange} dst-address=${genieacsServerIp} dst-port=${genieacsPort} protocol=tcp action=accept comment="genieacs-allow-tr069"

# Allow DNS queries ke GenieACS
/ip firewall filter add chain=forward src-address=${pppoeRange} dst-address=${genieacsServerIp} dst-port=53 protocol=udp action=accept comment="genieacs-allow-dns"

# Allow HTTPS TR069 (jika menggunakan HTTPS)
/ip firewall filter add chain=forward src-address=${pppoeRange} dst-address=${genieacsServerIp} dst-port=7548 protocol=tcp action=accept comment="genieacs-allow-tr069-https"

# ===========================================
# 5. SETUP PPP PROFILE - Update DNS untuk PPPoE
# ===========================================

# Update PPP profile untuk memberikan DNS GenieACS
/ppp profile set [find name="default"] dns-server="${genieacsServerIp},${dnsBackup}" comment="GenieACS DNS Configuration"

# ===========================================
# 6. SETUP ADDRESS LIST - Untuk monitoring
# ===========================================

# Hapus address list lama (jika ada)
/ip firewall address-list remove [find list="genieacs-clients"]

# Tambahkan address list untuk monitoring
/ip firewall address-list add list="genieacs-clients" address=${pppoeRange} comment="PPPoE Clients for GenieACS"

# ===========================================
# 7. SETUP LOGGING - Monitor TR069 Activity
# ===========================================

# Hapus logging rules lama (jika ada)
/system logging remove [find topics="genieacs"]

# Tambahkan logging untuk TR069 activity
/system logging add topics=genieacs action=memory comment="GenieACS TR069 Activity"

# ===========================================
# 8. VERIFIKASI KONFIGURASI
# ===========================================

:put ""
:put "=== VERIFIKASI KONFIGURASI ==="
:put "GenieACS Server: ${genieacsServerIp}:${genieacsPort}"
:put "PPPoE Range: ${pppoeRange}"
:put "DNS Backup: ${dnsBackup}"
:put ""
:put "=== DNS STATIC ==="
/ip dns static print where name~"genieacs|tr069"
:put ""
:put "=== DHCP SERVER DNS ==="
/ip dhcp-server network print where address="${pppoeRange}"
:put ""
:put "=== NAT RULES ==="
/ip firewall nat print where comment~"genieacs"
:put ""
:put "=== FIREWALL RULES ==="
/ip firewall filter print where comment~"genieacs"
:put ""
:put "=== PPP PROFILE ==="
/ppp profile print where name="default"
:put ""
:put "=== ADDRESS LIST ==="
/ip firewall address-list print where list="genieacs-clients"
:put ""
:put "=== KONFIGURASI SELESAI ==="
:put "Script berhasil dijalankan!"
:put "ONUs sekarang akan menggunakan GenieACS sebagai DNS server"
:put "Port TR069: ${genieacsPort} (HTTP), 7548 (HTTPS)"
:put "==========================================="`;

            return script;
        }

        // Copy script to clipboard
        function copyMikrotikDNSGenieACSScript() {
            const scriptContent = document.getElementById('mikrotikDNSGenieACSScriptContent').textContent;

            navigator.clipboard.writeText(scriptContent).then(() => {
                showNotification('success', 'Script berhasil dicopy ke clipboard!');
            }).catch(err => {
                showNotification('error', 'Gagal copy script: ' + err.message);
            });
        }

        // Download script as file
        function downloadMikrotikDNSGenieACSScript() {
            const scriptContent = document.getElementById('mikrotikDNSGenieACSScriptContent').textContent;
            const genieacsServerIp = document.getElementById('genieacsServerIp').value.trim();
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `mikrotik-dns-genieacs-${genieacsServerIp.replace(/\./g, '-')}-${timestamp}.rsc`;

            const blob = new Blob([scriptContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showNotification('success', `Script berhasil didownload: ${filename}`);
        }

        // Functions untuk Script Generator Menu Isolir Mikrotik
        function generateIsolirScript() {
            const activeIp = document.getElementById('activeIp').value.trim();
            const isolirIp = document.getElementById('isolirIp').value.trim();
            const isolirDomain = document.getElementById('isolirDomain').value.trim();
            const isolirPath = document.getElementById('isolirPath').value.trim();
            const isolirPort = document.getElementById('isolirPort').value.trim();
            const accessType = document.getElementById('accessType').value;

            // Validasi input
            if (!activeIp || !isolirIp || !isolirDomain || !isolirPath) {
                showNotification('warning', 'Mohon lengkapi field yang wajib!');
                return;
            }

            // Validasi port untuk akses langsung
            if (accessType === 'port' && !isolirPort) {
                showNotification('warning', 'Port wajib diisi untuk akses langsung!');
                return;
            }

            // Validasi format IP
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipRegex.test(activeIp) || !ipRegex.test(isolirIp)) {
                showNotification('warning', 'Format IP tidak valid!');
                return;
            }

            // Generate script Mikrotik
            const isolirUrl = accessType === 'tunneling'
                ? isolirDomain + isolirPath
                : isolirDomain + ':' + isolirPort + isolirPath;

            const script = [
                '# Script Menu Isolir Mikrotik - Enhanced Version',
                '# Generated on: ' + new Date().toLocaleString('id-ID'),
                '# IP PPPoE Aktif: ' + activeIp,
                '# IP PPPoE Isolir: ' + isolirIp,
                '# URL Halaman Isolir: ' + isolirUrl,
                '# Jenis Akses: ' + (accessType === 'tunneling' ? 'Tunneling' : 'Port Langsung'),
                '',
                '# ===========================================',
                '# 1. SETUP DNS STATIC - Arahkan semua domain ke aplikasi',
                '# ===========================================',
                '',
                '# Hapus DNS static lama (jika ada)',
                '/ip dns static remove [find where name="' + isolirDomain + '" and address="' + isolirIp + '"]',
                '',
                '# Tambahkan DNS static untuk domain aplikasi',
                '/ip dns static add name="' + isolirDomain + '" address="' + isolirIp + '" ttl=300',
                '',
                '# Arahkan domain populer ke aplikasi (opsional)',
                '/ip dns static add name="google.com" address="' + isolirIp + '" ttl=300',
                '/ip dns static add name="facebook.com" address="' + isolirIp + '" ttl=300',
                '/ip dns static add name="youtube.com" address="' + isolirIp + '" ttl=300',
                '/ip dns static add name="instagram.com" address="' + isolirIp + '" ttl=300',
                '',
                '# ===========================================',
                '# 2. SETUP NAT RULES - Redirect HTTP/HTTPS ke aplikasi',
                '# ===========================================',
                '',
                '# Hapus NAT rules lama (jika ada)',
                '/ip firewall nat remove [find where comment~"isolir-redirect"]',
                '',
                '# ===========================================',
                '# 3. SETUP FIREWALL RULES - Block semua kecuali aplikasi',
                '# ===========================================',
                '',
                '# Hapus firewall rules lama (jika ada)',
                '/ip firewall filter remove [find where comment~"isolir"]',
                '',
                '# ===========================================',
                '# 4. SETUP PPP PROFILE ISOLIR',
                '# ===========================================',
                '',
                '# Buat profile isolir jika belum ada',
                '/ppp profile add name="isolir" local-address=' + isolirIp + ' remote-address=' + isolirIp + ' \\',
                '    rate-limit="0/0" comment="Profile untuk pelanggan yang diisolir"',
                '',
                '# ===========================================',
                '# 5. SETUP ADDRESS LIST - Untuk kemudahan management',
                '# ===========================================',
                '',
                '# Hapus address list lama (jika ada)',
                '/ip firewall address-list remove [find where list="isolir-users"]',
                '',
                '# Tambahkan IP range isolir ke address list',
                '/ip firewall address-list add address=' + isolirIp + '/32 list="isolir-users" comment="PPPoE Isolir Users"'
            ];

            if (accessType === 'tunneling') {
                // Untuk tunneling, redirect ke domain + path
                script.push(
                    '# Redirect HTTP traffic ke aplikasi',
                    '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=80 protocol=tcp \\',
                    '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=80 \\',
                    '    comment="isolir-redirect-http"',
                    '',
                    '# Redirect HTTPS traffic ke aplikasi',
                    '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=443 protocol=tcp \\',
                    '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=443 \\',
                    '    comment="isolir-redirect-https"',
                    '',
                    '# Allow DNS queries ke aplikasi',
                    '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                    '    dst-address=' + isolirDomain + ' dst-port=53 protocol=udp \\',
                    '    action=accept comment="isolir-allow-dns"',
                    '',
                    '# Allow HTTP/HTTPS ke aplikasi',
                    '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                    '    dst-address=' + isolirDomain + ' dst-port=80,443 protocol=tcp \\',
                    '    action=accept comment="isolir-allow-app"',
                    '',
                    '# Block semua traffic lainnya',
                    '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                    '    action=drop comment="isolir-block-all"'
                );
            } else {
                // Untuk port langsung
                script.push(
                    '# Redirect HTTP traffic ke aplikasi lokal',
                    '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=80 protocol=tcp \\',
                    '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
                    '    comment="isolir-redirect-http"',
                    '',
                    '# Redirect HTTPS traffic ke aplikasi lokal',
                    '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=443 protocol=tcp \\',
                    '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
                    '    comment="isolir-redirect-https"',
                    '',
                    '# Allow DNS queries ke aplikasi lokal',
                    '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                    '    dst-address=' + isolirDomain + ' dst-port=53 protocol=udp \\',
                    '    action=accept comment="isolir-allow-dns"',
                    '',
                    '# Allow HTTP/HTTPS ke aplikasi lokal',
                    '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                    '    dst-address=' + isolirDomain + ' dst-port=' + isolirPort + ' protocol=tcp \\',
                    '    action=accept comment="isolir-allow-app"',
                    '',
                    '# Block semua traffic lainnya',
                    '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                    '    action=drop comment="isolir-block-all"'
                );
            }

            script.push(
                '',
                '# ===========================================',
                '# 6. SCRIPT MANAGEMENT - Isolir & Restore',
                '# ===========================================',
                '',
                '# Script untuk isolir pelanggan',
                '# Gunakan script ini untuk mengisolir pelanggan:',
                '# :local username "nama_pelanggan"',
                '# /ppp secret set [find name=$username] profile=isolir',
                '# :log info "Pelanggan $username telah diisolir"',
                '',
                '# Script untuk restore pelanggan',
                '# Gunakan script ini untuk restore pelanggan:',
                '# :local username "nama_pelanggan"',
                '# /ppp secret set [find name=$username] profile=default',
                '# :log info "Pelanggan $username telah direstore"',
                '',
                '# ===========================================',
                '# 7. VERIFIKASI KONFIGURASI',
                '# ===========================================',
                '',
                ':put "=== KONFIGURASI ISOLIR SELESAI ==="',
                ':put "User PPPoE di ' + isolirIp + ' akan diarahkan ke aplikasi"',
                ':put "Aplikasi: ' + isolirUrl + '"',
                ':put ""',
                ':put "=== VERIFIKASI ==="',
                '',
                '# Cek DNS static',
                ':put "DNS Static Rules:"',
                '/ip dns static print where name~"' + isolirDomain + '"',
                '',
                '# Cek NAT rules',
                ':put "NAT Rules:"',
                '/ip firewall nat print where comment~"isolir"',
                '',
                '# Cek Firewall rules',
                ':put "Firewall Rules:"',
                '/ip firewall filter print where comment~"isolir"',
                '',
                '# Cek Address List',
                ':put "Address List:"',
                '/ip firewall address-list print where list="isolir-users"',
                '',
                ':put ""',
                ':put "=== CARA KERJA ==="',
                ':put "1. User PPPoE terisolir mendapat IP: ' + isolirIp + '"',
                ':put "2. DNS query untuk domain apapun diarahkan ke: ' + isolirDomain + '"',
                ':put "3. HTTP/HTTPS request di-redirect ke: ' + isolirUrl + '"',
                ':put "4. Aplikasi menampilkan halaman isolir"',
                ':put "5. Traffic lainnya di-block"',
                ':put ""',
                ':put "=== SELESAI ==="',
                '',
                'echo "Script menu isolir Mikrotik telah dibuat!"',
                'echo "Pastikan halaman isolir dapat diakses dari IP: ' + isolirIp + '"',
                'echo "URL halaman isolir: ' + isolirUrl + '"'
            );

            const finalScript = script.join('\n');

            // Tampilkan script
            document.getElementById('isolirScript').textContent = finalScript;
            document.getElementById('isolirScriptCard').style.display = 'block';

            showNotification('success', 'Script berhasil di-generate!');
        }

        function generateLocalIsolirScript() {
            const activeIp = document.getElementById('activeIp').value.trim();
            const isolirIp = document.getElementById('isolirIp').value.trim();
            const isolirDomain = document.getElementById('isolirDomain').value.trim();
            const isolirPath = document.getElementById('isolirPath').value.trim();
            const isolirPort = document.getElementById('isolirPort').value.trim();

            // Validasi input
            if (!activeIp || !isolirIp || !isolirDomain || !isolirPath || !isolirPort) {
                showNotification('warning', 'Mohon lengkapi semua field!');
                return;
            }

            // Validasi format IP
            const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipRegex.test(activeIp) || !ipRegex.test(isolirIp)) {
                showNotification('warning', 'Format IP tidak valid!');
                return;
            }

            // Generate script Mikrotik untuk aplikasi lokal
            const script = [
                '# Script Mikrotik untuk User PPPoE Terisolir - Aplikasi Lokal',
                '# Generated on: ' + new Date().toLocaleString('id-ID'),
                '# IP PPPoE Aktif: ' + activeIp,
                '# IP PPPoE Isolir: ' + isolirIp,
                '# Aplikasi Lokal: ' + isolirDomain + ':' + isolirPort + isolirPath,
                '',
                '# ===========================================',
                '# 1. DNS STATIC - Arahkan semua domain ke aplikasi lokal',
                '# ===========================================',
                '',
                '# Hapus DNS static lama (jika ada)',
                '/ip dns static remove [find where name="' + isolirDomain + '" and address="' + isolirDomain + '"]',
                '',
                '# Tambahkan DNS static untuk domain aplikasi',
                '/ip dns static add name="' + isolirDomain + '" address="' + isolirDomain + '" ttl=300',
                '',
                '# Arahkan domain populer ke aplikasi lokal',
                '/ip dns static add name="google.com" address="' + isolirDomain + '" ttl=300',
                '/ip dns static add name="facebook.com" address="' + isolirDomain + '" ttl=300',
                '/ip dns static add name="youtube.com" address="' + isolirDomain + '" ttl=300',
                '/ip dns static add name="instagram.com" address="' + isolirDomain + '" ttl=300',
                '/ip dns static add name="twitter.com" address="' + isolirDomain + '" ttl=300',
                '/ip dns static add name="tiktok.com" address="' + isolirDomain + '" ttl=300',
                '/ip dns static add name="whatsapp.com" address="' + isolirDomain + '" ttl=300',
                '/ip dns static add name="telegram.org" address="' + isolirDomain + '" ttl=300',
                '',
                '# ===========================================',
                '# 2. NAT RULES - Redirect HTTP/HTTPS ke aplikasi lokal',
                '# ===========================================',
                '',
                '# Hapus NAT rules lama (jika ada)',
                '/ip firewall nat remove [find where comment~"isolir-redirect"]',
                '',
                '# Redirect HTTP traffic ke aplikasi lokal',
                '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=80 protocol=tcp \\',
                '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
                '    comment="isolir-redirect-http"',
                '',
                '# Redirect HTTPS traffic ke aplikasi lokal',
                '/ip firewall nat add chain=dstnat src-address=' + isolirIp + '/32 dst-port=443 protocol=tcp \\',
                '    action=dst-nat to-addresses=' + isolirDomain + ' to-ports=' + isolirPort + ' \\',
                '    comment="isolir-redirect-https"',
                '',
                '# ===========================================',
                '# 3. FIREWALL RULES - Block semua kecuali aplikasi lokal',
                '# ===========================================',
                '',
                '# Hapus firewall rules lama (jika ada)',
                '/ip firewall filter remove [find where comment~"isolir"]',
                '',
                '# Allow DNS queries ke aplikasi lokal',
                '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                '    dst-address=' + isolirDomain + ' dst-port=53 protocol=udp \\',
                '    action=accept comment="isolir-allow-dns"',
                '',
                '# Allow HTTP/HTTPS ke aplikasi lokal',
                '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                '    dst-address=' + isolirDomain + ' dst-port=' + isolirPort + ' protocol=tcp \\',
                '    action=accept comment="isolir-allow-app"',
                '',
                '# Block semua traffic lainnya',
                '/ip firewall filter add chain=forward src-address=' + isolirIp + '/32 \\',
                '    action=drop comment="isolir-block-all"',
                '',
                '# ===========================================',
                '# 4. ADDRESS LIST - Untuk kemudahan management',
                '# ===========================================',
                '',
                '# Hapus address list lama (jika ada)',
                '/ip firewall address-list remove [find where list="isolir-users"]',
                '',
                '# Tambahkan IP range isolir ke address list',
                '/ip firewall address-list add address=' + isolirIp + '/32 list="isolir-users" comment="PPPoE Isolir Users"',
                '',
                '# ===========================================',
                '# 5. VERIFIKASI KONFIGURASI',
                '# ===========================================',
                '',
                ':put "=== KONFIGURASI ISOLIR LOKAL SELESAI ==="',
                ':put "User PPPoE di ' + isolirIp + ' akan diarahkan ke aplikasi lokal"',
                ':put "Aplikasi lokal: http://' + isolirDomain + ':' + isolirPort + isolirPath + '"',
                ':put ""',
                ':put "=== VERIFIKASI ==="',
                '',
                '# Cek DNS static',
                ':put "DNS Static Rules:"',
                '/ip dns static print where name~"' + isolirDomain + '"',
                '',
                '# Cek NAT rules',
                ':put "NAT Rules:"',
                '/ip firewall nat print where comment~"isolir"',
                '',
                '# Cek Firewall rules',
                ':put "Firewall Rules:"',
                '/ip firewall filter print where comment~"isolir"',
                '',
                '# Cek Address List',
                ':put "Address List:"',
                '/ip firewall address-list print where list="isolir-users"',
                '',
                ':put ""',
                ':put "=== CARA KERJA ==="',
                ':put "1. User PPPoE terisolir mendapat IP: ' + isolirIp + '"',
                ':put "2. DNS query untuk domain apapun diarahkan ke: ' + isolirDomain + '"',
                ':put "3. HTTP/HTTPS request di-redirect ke: ' + isolirDomain + ':' + isolirPort + '"',
                ':put "4. Aplikasi lokal menampilkan halaman isolir"',
                ':put "5. Traffic lainnya di-block"',
                ':put ""',
                ':put "=== SELESAI ==="',
                '',
                'echo "Script isolir lokal Mikrotik telah dibuat!"',
                'echo "Pastikan aplikasi lokal berjalan di: ' + isolirDomain + ':' + isolirPort + '"',
                'echo "Halaman isolir: http://' + isolirDomain + ':' + isolirPort + isolirPath + '"'
            ];

            const finalScript = script.join('\n');

            // Tampilkan script
            document.getElementById('isolirScript').textContent = finalScript;
            document.getElementById('isolirScriptCard').style.display = 'block';

            showNotification('success', 'Script isolir lokal berhasil di-generate!');
        }

        function copyIsolirScript() {
            const scriptElement = document.getElementById('isolirScript');
            if (!scriptElement || !scriptElement.textContent) {
                showNotification('warning', 'Tidak ada script untuk di-copy!');
                return;
            }

            navigator.clipboard.writeText(scriptElement.textContent).then(function () {
                showNotification('success', 'Script berhasil di-copy ke clipboard!');
            }).catch(function (err) {
                // Fallback untuk browser lama
                const textArea = document.createElement('textarea');
                textArea.value = scriptElement.textContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('success', 'Script berhasil di-copy ke clipboard!');
            });
        }

        // Auto-generate script saat input berubah
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = ['activeIp', 'isolirIp', 'isolirDomain', 'isolirPath'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function () {
                        // Auto-generate jika semua field wajib sudah terisi
                        const allFilled = inputs.every(inputId => {
                            const el = document.getElementById(inputId);
                            return el && el.value.trim();
                        });

                        if (allFilled) {
                            // Delay sedikit untuk UX yang lebih baik
                            setTimeout(() => {
                                generateIsolirScript();
                            }, 500);
                        }
                    });
                }
            });

            // Handle access type change
            const accessTypeSelect = document.getElementById('accessType');
            if (accessTypeSelect) {
                accessTypeSelect.addEventListener('change', function () {
                    const portField = document.getElementById('isolirPort');
                    if (this.value === 'tunneling') {
                        portField.placeholder = 'Kosongkan jika menggunakan tunneling';
                        portField.value = '';
                    } else {
                        portField.placeholder = 'Masukkan port (contoh: 3000)';
                    }
                });
            }
        });
    </script>

    <!-- Modal untuk Preview Script -->
    <div class="modal fade" id="scriptPreviewModal" tabindex="-1" aria-labelledby="scriptPreviewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scriptPreviewModalLabel">
                        <i class="bi bi-code-square"></i> Preview Script Mikrotik
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>Cara menggunakan:</strong>
                        1. Copy script di bawah → 2. Paste di terminal Mikrotik → 3. Jalankan script
                    </div>
                    <pre class="bg-light p-3 rounded"
                        style="max-height: 500px; overflow-y: auto; font-size: 12px; font-family: 'Courier New', monospace;"><code id="previewScriptContent"></code></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="copyPreviewScriptBtn">
                        <i class="bi bi-clipboard"></i> Copy Script
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Handler untuk copy script dari modal preview
        $('#copyPreviewScriptBtn').on('click', function () {
            const script = $('#previewScriptContent').text();
            navigator.clipboard.writeText(script).then(function () {
                showNotification('success', 'Script tersalin ke clipboard!');
                $('#scriptPreviewModal').modal('hide');
            }).catch(function (err) {
                console.error('Error copying script:', err);
                showNotification('danger', 'Gagal menyalin script!');
            });
        });

        // Handler untuk preview script
        $('#previewIsolationScript').on('click', function () {
            const script = $('#isolationScriptResult').val();
            if (!script) {
                showNotification('warning', 'Generate script terlebih dahulu');
                return;
            }

            $('#previewScriptContent').text(script);
            new bootstrap.Modal(document.getElementById('scriptPreviewModal')).show();
        });

    </script>

</body>

</html>