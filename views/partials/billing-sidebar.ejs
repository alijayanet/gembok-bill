<!-- Mobile Top Navbar (Only visible on mobile) -->
<nav class="navbar navbar-expand-md navbar-dark d-md-none mobile-navbar">
    <div class="container-fluid">
        <div class="d-flex align-items-center">
            <button class="btn btn-link text-white p-0 me-3" type="button" id="sidebarToggle">
                <i class="bx bx-menu" style="font-size: 1.5rem;"></i>
            </button>
            <img src="/img/GEMBOK-Bill.png?ts=<%= Date.now() %>" alt="GEMBOK Bill Logo"
                style="height: 35px; border-radius: 4px;">
            <span class="navbar-brand ms-2 mb-0">Billing Admin</span>
        </div>
    </div>
</nav>

<!-- Overlay for mobile sidebar -->
<div class="sidebar-overlay d-md-none" id="sidebarOverlay"></div>

<!-- Billing Sidebar -->
<nav class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebar">
    <div class="position-sticky pt-3">
        <!-- Close button for mobile -->
        <div class="d-md-none text-end p-3">
            <button class="btn btn-link text-white p-0" id="sidebarClose">
                <i class="bx bx-x" style="font-size: 1.5rem;"></i>
            </button>
        </div>

        <!-- Logo Section -->
        <div class="sidebar-header mb-4 text-center">
            <img src="/img/GEMBOK-Bill.png?ts=<%= Date.now() %>" alt="GEMBOK Bill Logo"
                style="max-width:120px;max-height:60px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        </div>

        <div class="sidebar-links">
            <a href="/admin" class="<%= typeof page !== 'undefined' && page === 'dashboard' ? 'active' : '' %>"><i
                    class="bi bi-house"></i> Dashboard Utama</a>
            <a href="/admin/billing/dashboard"
                class="<%= typeof page !== 'undefined' && page === 'billing' ? 'active' : '' %>"><i
                    class="bi bi-bar-chart-alt-2"></i>
                Dashboard Billing</a>
            <a href="/admin/billing/customers"
                class="<%= typeof page !== 'undefined' && page === 'customers' ? 'active' : '' %>"><i
                    class="bi bi-users"></i>
                Pelanggan & Paket</a>
            <a href="/admin/billing/invoices"
                class="<%= typeof page !== 'undefined' && page === 'invoices' ? 'active' : '' %>"><i
                    class="bi bi-receipt"></i>
                Invoice</a>
            <a href="/admin/billing/payments"
                class="<%= typeof page !== 'undefined' && page === 'payments' ? 'active' : '' %>"><i
                    class="bi bi-credit-card"></i>
                Pembayaran & Keuangan</a>
            <a href="/admin/collectors"
                class="<%= typeof page !== 'undefined' && page === 'collectors' ? 'active' : '' %>"><i
                    class="bi bi-group"></i>
                Kolektor</a>
            <a href="/admin/billing/payment-settings"
                class="<%= typeof page !== 'undefined' && page === 'payment-settings' ? 'active' : '' %>"><i
                    class="bi bi-cog"></i>
                Pengaturan</a>
        </div>

        <!-- Version Info -->
        <div class="version-info text-center mb-3">
            <small class="text-muted">
                <div class="version-details">
                    <strong>Version Info</strong><br>
                    <span id="versionDisplay">
                        <%= typeof versionInfo !=='undefined' ? 'v' + versionInfo.version : 'v1.0.0' %>
                    </span><br>
                    Build: <span id="buildDisplay">
                        <%= typeof versionInfo !=='undefined' ? versionInfo.buildNumber : '001' %>
                    </span><br>
                    Released: <span id="releaseDate">
                        <%= typeof versionInfo !=='undefined' ? versionInfo.versionDate : 'N/A' %>
                    </span>
                </div>
            </small>
        </div>

        <!-- Update Menu -->
        <div class="update-menu mb-3">
            <button class="btn btn-sm btn-outline-light w-100" id="checkUpdateBtn">
                <i class="bi bi-arrow-repeat"></i> Cek Update
            </button>
            <div id="updateStatus" class="text-center mt-2" style="font-size: 0.75rem;"></div>
        </div>
    </div>
</nav>

<style>
    /* Mobile Top Navbar */
    .mobile-navbar {
        background: #111827;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1001;
        padding: 0.5rem 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .mobile-navbar .navbar-brand {
        font-size: 1.1rem;
        font-weight: 600;
    }

    /* Sidebar Overlay */
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .sidebar-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    /* Billing Sidebar Styling */
    #sidebar {
        background: #111827 !important;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 767.98px) {
        #sidebar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            bottom: 0 !important;
            width: 280px !important;
            z-index: 1000 !important;
            transform: translateX(-100%) !important;
            transition: transform 0.3s ease-in-out !important;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3) !important;
        }

        #sidebar.show {
            transform: translateX(0) !important;
        }

        .main-content {
            margin-left: 0 !important;
            margin-top: 60px !important;
            /* Space for mobile navbar */
            padding: 15px !important;
        }
    }

    @media (max-width: 575.98px) {
        #sidebar {
            width: 260px !important;
        }
    }

    @media (min-width: 768px) {
        .main-content {
            margin-left: 16.666667%;
            /* col-md-3 width */
        }
    }

    #sidebar .sidebar-header,
    #sidebar .version-info {
        text-align: center;
    }

    #sidebar .sidebar-links a {
        color: rgba(255, 255, 255, 0.8);
        display: block;
        padding: 0.75rem 1rem;
        margin: 0.125rem 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    #sidebar .sidebar-links a:hover,
    #sidebar .sidebar-links a.active {
        color: white !important;
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateX(3px);
    }

    #sidebar .sidebar-links a i {
        margin-right: 0.5rem;
        font-size: 1.1rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const checkUpdateBtn = document.getElementById('checkUpdateBtn');
        const updateStatus = document.getElementById('updateStatus');

        // Toggle sidebar on hamburger click
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function () {
                sidebar.classList.add('show');
                overlay.classList.add('show');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            });
        }

        // Close sidebar functions
        function closeSidebar() {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Close sidebar on close button click
        if (sidebarClose) {
            sidebarClose.addEventListener('click', closeSidebar);
        }

        // Close sidebar on overlay click
        if (overlay) {
            overlay.addEventListener('click', closeSidebar);
        }

        // Close sidebar when clicking on nav links (mobile)
        const navLinks = sidebar.querySelectorAll('.sidebar-links a');
        navLinks.forEach(link => {
            link.addEventListener('click', function () {
                if (window.innerWidth < 768) {
                    setTimeout(closeSidebar, 100); // Small delay for better UX
                }
            });
        });

        // Handle window resize
        window.addEventListener('resize', function () {
            if (window.innerWidth >= 768) {
                closeSidebar();
            }
        });

        // Prevent body scroll when sidebar is open on mobile
        sidebar.addEventListener('touchmove', function (e) {
            if (sidebar.classList.contains('show')) {
                e.stopPropagation();
            }
        });

        // Enable smooth scrolling for sidebar content on mobile
        const sidebarContent = sidebar.querySelector('.position-sticky');
        if (sidebarContent) {
            sidebarContent.style.webkitOverflowScrolling = 'touch';
            sidebarContent.style.overflowScrolling = 'touch';
        }

        // Check update functionality
        if (checkUpdateBtn) {
            checkUpdateBtn.addEventListener('click', async function () {
                checkUpdateBtn.disabled = true;
                checkUpdateBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Mengecek...';
                updateStatus.innerHTML = '<span class="text-info">Sedang mengecek update...</span>';

                try {
                    const response = await fetch('/api/version/check-update');
                    const data = await response.json();

                    if (data.success) {
                        if (data.hasUpdate) {
                            updateStatus.innerHTML = `<span class="text-success">✓ Update tersedia: v${data.latestVersion}</span>`;
                            checkUpdateBtn.innerHTML = '<i class="bi bi-download"></i> Update';
                            checkUpdateBtn.onclick = function () {
                                window.open(data.latestRelease.htmlUrl, '_blank');
                            };
                        } else {
                            updateStatus.innerHTML = '<span class="text-success">✓ Sudah versi terbaru</span>';
                            checkUpdateBtn.disabled = false;
                            checkUpdateBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Cek Update';
                        }
                    } else {
                        updateStatus.innerHTML = `<span class="text-danger">✗ Gagal mengecek update</span>`;
                        checkUpdateBtn.disabled = false;
                        checkUpdateBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Cek Update';
                    }
                } catch (error) {
                    console.error('Error checking update:', error);
                    updateStatus.innerHTML = '<span class="text-danger">✗ Error: ' + error.message + '</span>';
                    checkUpdateBtn.disabled = false;
                    checkUpdateBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Cek Update';
                }
            });
        }
    });
</script>

<style>
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .spin {
        animation: spin 1s linear infinite;
    }
</style>